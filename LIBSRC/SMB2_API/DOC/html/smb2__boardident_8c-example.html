<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - SMB2_API - Example Documentation</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;">
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">SMB2_API &nbsp; </h1>
	<h3>Example Documentation</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>smb2_boardident.c</h1><div class="fragment"><pre><span class="comment">/****************************************************************************</span>
<span class="comment"> ************                                                    ************</span>
<span class="comment"> ************                  SMB2_BOARDIDENT                   ************</span>
<span class="comment"> ************                                                    ************</span>
<span class="comment"> ****************************************************************************/</span>
<span class="comment">/*</span>
<span class="comment">* This program is free software: you can redistribute it and/or modify</span>
<span class="comment">* it under the terms of the GNU General Public License as published by</span>
<span class="comment">* the Free Software Foundation, either version 2 of the License, or</span>
<span class="comment">* (at your option) any later version.</span>
<span class="comment">*</span>
<span class="comment">* This program is distributed in the hope that it will be useful,</span>
<span class="comment">* but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment">* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment">* GNU General Public License for more details.</span>
<span class="comment">*</span>
<span class="comment">* You should have received a copy of the GNU General Public License</span>
<span class="comment">* along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="comment">*/</span>
<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> RCSid[]=<span class="stringliteral">"$Id: smb2_boardident.c,v 1.6 2014/07/17 17:00:15 ts Exp $"</span>;

<span class="comment">/*-------------------------------------+</span>
<span class="comment">|   INCLUDES                           |</span>
<span class="comment">+-------------------------------------*/</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/men_typs.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/mdis_api.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/usr_oss.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/usr_utl.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="smb2__api_8h.html">MEN/smb2_api.h</a>&gt;</span>
<span class="preprocessor">#include &lt;MEN/eeprod.h&gt;</span>     <span class="comment">/* for EEPROD2 struct/constants  */</span>

<span class="comment">/* still using deprecated sscanf, sprintf,.. */</span>
<span class="preprocessor">#ifdef WINNT</span>
<span class="preprocessor"></span><span class="preprocessor"># pragma warning(disable:4996)</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">/*-------------------------------------+</span>
<span class="comment">|   DEFINES                            |</span>
<span class="comment">+-------------------------------------*/</span>
<span class="preprocessor">#define DEFAULT_ID_PROM_ADDR    0xAE</span>
<span class="preprocessor"></span><span class="preprocessor">#define SMB_FLAGS    0x0</span>
<span class="preprocessor"></span><span class="preprocessor">#define ZZ           0xEE</span>
<span class="preprocessor"></span>
<span class="comment">/*-------------------------------------+</span>
<span class="comment">|   MAKROS                             |</span>
<span class="comment">+-------------------------------------*/</span>
<span class="preprocessor">#ifdef _BIG_ENDIAN_</span>
<span class="preprocessor"></span><span class="preprocessor"># define SWAPWORD(w) (w)</span>
<span class="preprocessor"></span><span class="preprocessor"># define SWAPLONG(l) (l)</span>
<span class="preprocessor"></span><span class="preprocessor">#elif defined(_LITTLE_ENDIAN_)</span>
<span class="preprocessor"></span><span class="preprocessor"># define SWAPWORD(w) ((((w)&amp;0xff)&lt;&lt;8) + (((w)&amp;0xff00)&gt;&gt;8))</span>
<span class="preprocessor"></span><span class="preprocessor"># define SWAPLONG(l) ((((l)&amp;0xff)&lt;&lt;24) + (((l)&amp;0xff00)&lt;&lt;8) + \</span>
<span class="preprocessor">                     (((l)&amp;0xff0000)&gt;&gt;8) + (((l)&amp;0xff000000)&gt;&gt;24))</span>
<span class="preprocessor"></span><span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor"># error "Must define _BIG_ENDIAN_ or _LITTLE_ENDIAN_"</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#if defined(_BIG_ENDIAN_) &amp;&amp; defined(_LITTLE_ENDIAN_)</span>
<span class="preprocessor"></span><span class="preprocessor"># error "Don't define _BIG/_LITTLE_ENDIAN_ together"</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">/*-------------------------------------+</span>
<span class="comment">|   GLOBALS                            |</span>
<span class="comment">+-------------------------------------*/</span>
<span class="keywordtype">void</span>    *SMB2EEPROD2_smbHdl;
EEPROD2 G_eeprd2;

<span class="comment">/*-------------------------------------+</span>
<span class="comment">|   PROTOTYPES                         |</span>
<span class="comment">+-------------------------------------*/</span>
<span class="keyword">static</span> int32   SmbIdPromRead( u_int8 );
<span class="keyword">static</span> <span class="keywordtype">void</span>    SmbIdPromDump( <span class="keywordtype">void</span> );
<span class="keyword">static</span> int32   CheckParity( <span class="keywordtype">void</span> );
<span class="keyword">static</span> u_int8  CalcParity( u_int8*, u_int32 );
<span class="keyword">static</span> <span class="keywordtype">void</span>    PrintError( <span class="keywordtype">char</span>*, int32 );

<span class="comment">/********************************* header **********************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> header(<span class="keywordtype">void</span>)
{
    printf(<span class="stringliteral">"\n==========================="</span>
           <span class="stringliteral">"\n===   SMB2_BOARDIDENT   ==="</span>
           <span class="stringliteral">"\n==========================="</span>
           <span class="stringliteral">"\n(c)Copyright 2009 by MEN Mikro Elektronik GmbH\n%s\n\n"</span>, RCSid);
}

<span class="comment">/********************************* usage ***********************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keywordtype">void</span>)
{
    printf(
        <span class="stringliteral">"\nUsage:    smb2_boardident  devName  [smbAddr]  [&lt;opts&gt;] \n"</span>
        <span class="stringliteral">"\nFunction: read data from SMB board information EEPROM \n"</span>
        <span class="stringliteral">"Options:\n"</span>
        <span class="stringliteral">"   devName    SMB device name e.g. smb2_1\n"</span>
        <span class="stringliteral">"   [smbAddr]  SMB address of the board information EEPROM - default: 0xae\n"</span>
        <span class="stringliteral">"   [-r]       dump raw board information EEPROM data \n"</span>
        <span class="stringliteral">"\nCalling examples:\n"</span>
        <span class="stringliteral">"\n- dump board information EEPROM (with raw data): \n"</span>
        <span class="stringliteral">"    smb2_boardident smb2_1 -r \n"</span>
        <span class="stringliteral">"\n- dump data from specified SMB address: \n"</span>
        <span class="stringliteral">"    smb2_boardident smb2_1 0xac  \n"</span>
        <span class="stringliteral">"\n(c)Copyright 2009 by MEN Mikro Elektronik GmbH\n%s\n\n"</span>, RCSid
        );
}

<span class="comment">/***************************************************************************/</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
    <span class="keywordtype">int</span>     err, ret=0, i=0;
    <span class="keywordtype">char</span>    *errstr=NULL, ebuf[100];

    <span class="keywordtype">int</span>     raw;
    <span class="keywordtype">char</span>    *deviceP=NULL, *addrP=NULL;
    u_int32 smbAddr=0x0;
    u_int8  byte;

    <span class="comment">/*--------------------+</span>
<span class="comment">    |  check arguments    |</span>
<span class="comment">    +--------------------*/</span>
    errstr = UTL_ILLIOPT(<span class="stringliteral">"?r"</span>, ebuf);  <span class="comment">/* check args */</span>
    <span class="keywordflow">if</span>(errstr) {
        printf(<span class="stringliteral">"*** %s\n"</span>, errstr);
        usage();
        <span class="keywordflow">return</span> 1;
    }
    <span class="keywordflow">if</span>( UTL_TSTOPT(<span class="stringliteral">"?"</span>) ) {
        usage();
        <span class="keywordflow">return</span> 0;
    }

    <span class="comment">/*----------------+</span>
<span class="comment">    |  Get arguments  |</span>
<span class="comment">    +----------------*/</span>
    <span class="keywordflow">for</span>( i=1; i&lt;argc; i++ ) {
        <span class="keywordflow">if</span>( *argv[i] != <span class="charliteral">'-'</span> ) {
            <span class="keywordflow">if</span>( deviceP == NULL ) {
                deviceP = argv[i];
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( addrP == NULL ) {
                addrP = argv[i];
                <span class="keywordflow">break</span>;
            }
        }
    }

    <span class="keywordflow">if</span>( !deviceP ) {
        usage();
        <span class="keywordflow">return</span> 0;
    }

    <span class="comment">/* SMB device(EEPROM) address */</span>
    <span class="keywordflow">if</span>( addrP != NULL ) {
        sscanf( addrP, <span class="stringliteral">"%x"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)&amp;smbAddr );
    }
    <span class="keywordflow">else</span> {
        smbAddr = DEFAULT_ID_PROM_ADDR; <span class="comment">/* 0xae */</span>
    }

    <span class="comment">/* show raw data ? */</span>
    raw = ( UTL_TSTOPT(<span class="stringliteral">"r"</span>) ? 1 : 0 );

    <span class="comment">/*--------------------+</span>
<span class="comment">    |  Init SMB2 library  |</span>
<span class="comment">    +--------------------*/</span>
    err = <a name="a0"></a><a class="code" href="group____SMB2__API.html#a1">SMB2API_Init</a>( deviceP, &amp;SMB2EEPROD2_smbHdl );
    <span class="keywordflow">if</span>( err ) {
        PrintError( <span class="stringliteral">"SMB2API_Init"</span>, err );
        ret=1;
        <span class="keywordflow">goto</span> EXIT;
    }

    <span class="comment">/* some output at the beginning */</span>
    header();
    printf(<span class="stringliteral">"Accessing %s: smbAddr 0x%2x\n"</span>, deviceP, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)smbAddr);

    <span class="comment">/* read content of EEPROM */</span>
    ret = SmbIdPromRead( (u_int8)smbAddr );
    <span class="keywordflow">if</span>( ret == 1 ) {
        printf(<span class="stringliteral">"***ERROR getting EEPROM access\n"</span>);
        <span class="keywordflow">goto</span> CLEANUP;
    }

    <span class="comment">/* check EEPROD2 ID and parity */</span>
    <span class="keywordflow">if</span>( (G_eeprd2.pd_id == 0xFF) || ( ((G_eeprd2.pd_id &gt;&gt; 4) != EEID_PD2) &amp;&amp;
                                      ((G_eeprd2.pd_id &gt;&gt; 4) != EEID_PD) ) ) {
        printf( <span class="stringliteral">"\n***ERROR - Invalid or empty EEPROM!!!\n"</span> );
        ret = 1;
        <span class="keywordflow">goto</span> CLEANUP;
    }
    <span class="keywordflow">else</span> {
        <span class="comment">/*-----------------+</span>
<span class="comment">        |  dump IDPROM     |</span>
<span class="comment">        +-----------------*/</span>
        <span class="keywordflow">if</span>( (G_eeprd2.pd_id &gt;&gt; 4) == EEID_PD2 ) {
            <span class="comment">/* check validity of EEPROM */</span>
            <span class="keywordflow">if</span>( CheckParity() != 0 ) {
                printf( <span class="stringliteral">"\nCHKSUM ERROR - Invalid EEPROM!!!\n"</span> );
                printf( <span class="stringliteral">"\nDUMP EEPROM (INVALID!!):\n"</span> );
                ret = 1;
            }
            <span class="keywordflow">else</span> {
                printf(<span class="stringliteral">"\nDUMP EEPROM:\n"</span>);
                ret = 0;
            }
        }
        <span class="keywordflow">else</span> {  <span class="comment">/* EEID_PD */</span>
            printf(<span class="stringliteral">"\nDUMP EEPROM:\n"</span>);
            ret = 0;
        }

        SmbIdPromDump();

        <span class="comment">/* display RAW data */</span>
        <span class="keywordflow">if</span>( raw ) {
            printf(<span class="stringliteral">"\nRAW EEPROM DATA: \n\n"</span>);
            <span class="keywordflow">for</span>( i=0; i&lt;<span class="keyword">sizeof</span>(EEPROD2); i++ ) {
                err = <a name="a1"></a><a class="code" href="group____SMB2__API.html#a7">SMB2API_ReadByteData</a>( SMB2EEPROD2_smbHdl, SMB_FLAGS, (u_int8)smbAddr, (u_int8)i, &amp;byte );
                UOS_Delay(10); <span class="comment">/* wait 10ms */</span>
                <span class="keywordflow">if</span>( err ) {
                    PrintError( <span class="stringliteral">"SMB2API_ReadByteData"</span>, err );
                    ret=1;
                }
                printf(<span class="stringliteral">" %02X"</span>, byte );
                <span class="keywordflow">if</span>( !((i+1)%8) ) {
                    printf(<span class="stringliteral">"\n"</span>);
                }
            }
        }
    }

CLEANUP:
    <span class="comment">/*--------------------+</span>
<span class="comment">    |  Exit SMB2 library  |</span>
<span class="comment">    +--------------------*/</span>
    err = <a name="a2"></a><a class="code" href="group____SMB2__API.html#a2">SMB2API_Exit</a>( &amp;SMB2EEPROD2_smbHdl );
    <span class="keywordflow">if</span>( err ) {
        PrintError( <span class="stringliteral">"SMB2API_Exit"</span>, err );
        ret=1;
    }

EXIT:
    <span class="keywordflow">return</span> ret;
}

<span class="comment">/******************************* SmbIdPromRead ********************************/</span>
<span class="keyword">static</span> int32 SmbIdPromRead( u_int8 smbAddr )
{
    <span class="keywordtype">int</span>    err=0;
    u_int8 i=0;
    u_int8 *arr;
    
    arr = (u_int8*)&amp;G_eeprd2;

    <span class="keywordflow">for</span>( i=0; i&lt;<span class="keyword">sizeof</span>(EEPROD2); i++ ) {
        err = <a class="code" href="group____SMB2__API.html#a7">SMB2API_ReadByteData</a>( SMB2EEPROD2_smbHdl, SMB_FLAGS, smbAddr, i, &amp;arr[i] );
        UOS_Delay(10); <span class="comment">/* wait 10ms */</span>
        <span class="keywordflow">if</span>( err ) {
            PrintError( <span class="stringliteral">"SMB2API_ReadByteData"</span>, err );
            <span class="keywordflow">return</span> 1;
        }
    }
    UOS_Delay(50); <span class="comment">/* wait 50ms */</span>

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/******************************* SmbIdPromDump ********************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> SmbIdPromDump(<span class="keywordtype">void</span>)
{
    u_int8  prodday=0, prodmonth=0;
    u_int8  repday=0, repmonth=0;
    u_int16 prodyear=0, repyear=0;

    printf( <span class="stringliteral">"\n EEPROD-ID  = 0x%X\n"</span>, (G_eeprd2.pd_id &gt;&gt; 4) );

    <span class="keywordflow">if</span>( G_eeprd2.pd_serial == 0xFFFFFFFF ) {
        printf( <span class="stringliteral">" Serial#    = 0x%X\n"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(SWAPLONG(G_eeprd2.pd_serial)) );
    }
    <span class="keywordflow">else</span> {
        printf( <span class="stringliteral">" Serial#    = %08u\n"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(SWAPLONG(G_eeprd2.pd_serial)) );
    }

    <span class="keywordflow">if</span>( (G_eeprd2.pd_revision[0] == 0xFF) || (G_eeprd2.pd_revision[1] == 0xFF)
        || (G_eeprd2.pd_revision[2] == 0xFF) ) {
        printf( <span class="stringliteral">" Revision   = %02X.%02X.%02X\n"</span>, G_eeprd2.pd_revision[0],
            G_eeprd2.pd_revision[1], G_eeprd2.pd_revision[2] );
    }
    <span class="keywordflow">else</span> {
        printf( <span class="stringliteral">" Revision   = %02d.%02d.%02d\n"</span>, G_eeprd2.pd_revision[0],
            G_eeprd2.pd_revision[1], G_eeprd2.pd_revision[2] );
    }

    <span class="comment">/* handle HW name */</span>
    <span class="keywordflow">if</span>( ((u_int8)G_eeprd2.pd_hwName[0]) == 0xFF ) {
        printf( <span class="stringliteral">" HW-Name    = FF%X-%02X\n"</span>,
                    (u_int8)G_eeprd2.pd_hwName[0], G_eeprd2.pd_model );
    }
    <span class="keywordflow">else</span> {
        <span class="keywordflow">if</span>( G_eeprd2.pd_model == ZZ ) {
            printf( <span class="stringliteral">" HW-Name    = %sZZ\n"</span>, G_eeprd2.pd_hwName );
        }
        <span class="keywordflow">else</span> {
            printf( <span class="stringliteral">" HW-Name    = %s%02u\n"</span>, G_eeprd2.pd_hwName, G_eeprd2.pd_model );
        }
    }

    <span class="comment">/* get ProdDat */</span>
    G_eeprd2.pd_prodat = SWAPWORD(G_eeprd2.pd_prodat);
    prodday = G_eeprd2.pd_prodat &amp; 0x001F;
    prodmonth = (G_eeprd2.pd_prodat &gt;&gt; 5) &amp; 0x000F;
    prodyear  = (G_eeprd2.pd_prodat  &gt;&gt; 9) &amp; 0x007F;
    prodyear += EEPROD2_DATE_YEAR_BIAS;

    <span class="keywordflow">if</span>( G_eeprd2.pd_prodat == 0xFFFF ) {
        printf( <span class="stringliteral">" Prod. Date = FFFF-FF-FF\n"</span> );
    }
    <span class="keywordflow">else</span> {
        printf( <span class="stringliteral">" Prod. Date = %04u-%02u-%02u\n"</span>, prodyear, prodmonth, prodday );
    }

    <span class="comment">/* get RepDat */</span>
    G_eeprd2.pd_repdat = SWAPWORD(G_eeprd2.pd_repdat);
    repday  = G_eeprd2.pd_repdat &amp; 0x001F;
    repmonth = (G_eeprd2.pd_repdat &gt;&gt; 5) &amp; 0x000F;
    repyear  = (G_eeprd2.pd_repdat  &gt;&gt; 9) &amp; 0x007F;
    repyear += EEPROD2_DATE_YEAR_BIAS;

    <span class="keywordflow">if</span> (G_eeprd2.pd_repdat == 0xFFFF) {
        printf( <span class="stringliteral">" Rep. Date  = FFFF-FF-FF\n"</span> );
    }
    <span class="keywordflow">else</span> {
        printf( <span class="stringliteral">" Rep. Date  = %04u-%02u-%02u\n"</span>, repyear, repmonth, repday );
    }

}

<span class="comment">/******************************** CheckParity *********************************/</span>
<span class="keyword">static</span> int32 CheckParity( <span class="keywordtype">void</span> )
{
    u_int8 chksum=0, parity=0;
    u_int8 *arr;
    <span class="keywordtype">int</span> error=0;

    arr = (u_int8*)&amp;G_eeprd2;

    <span class="comment">/* check parity */</span>
    chksum = G_eeprd2.pd_id &amp; 0x0F;
    parity = CalcParity( &amp;arr[1], (<span class="keyword">sizeof</span>(EEPROD2)-1) );
    <span class="keywordflow">if</span>( parity != chksum ) {
        error = 1; <span class="comment">/* Checksum wrong */</span>
    }
    <span class="comment">/* we only report an error if we don't have a valid parity */</span>
    <span class="keywordflow">return</span> error;
}

<span class="comment">/********************************* CalcParity *********************************/</span>
<span class="keyword">static</span> u_int8 CalcParity( u_int8 *ptr, u_int32 len )
{
    u_int8 parity = 0xF;

    <span class="keywordflow">while</span>( len-- ) {
        parity ^= (*ptr &gt;&gt; 4);
        parity ^= (*ptr &amp; 0xf);
        ptr++;
    }

    <span class="keywordflow">return</span> parity;
}

<span class="comment">/********************************* PrintError *********************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> PrintError( <span class="keywordtype">char</span> *info, int32 errCode )
{
    <span class="keyword">static</span> <span class="keywordtype">char</span> errMsg[512];

    <span class="keywordflow">if</span>( !errCode )
        errCode = UOS_ErrnoGet();

    printf( <span class="stringliteral">"*** can't %s: %s\n"</span>, info, <a name="a3"></a><a class="code" href="group____SMB2__API.html#a16">SMB2API_Errstring</a>( errCode, errMsg ) );

}
</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for SMB2_API using <a href="http://www.doxygen.org">doxygen</a>.<br>
	Copyright &copy; 2019 <a href="http://www.men.de">MEN Mikro Elektronik GmbH</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

