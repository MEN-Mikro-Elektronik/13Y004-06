<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - SMB2_API - Example Documentation</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;"></a>
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">SMB2_API &nbsp; for SMB2 fileset 1.38</h1>
	<h3>Example Documentation</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>smb2_f601.c</h1><div class="fragment"><pre><span class="comment">/****************************************************************************</span>
<span class="comment"> ************                                                    ************</span>
<span class="comment"> ************                   SMB2_F601                         ************</span>
<span class="comment"> ************                                                    ************</span>
<span class="comment"> ****************************************************************************/</span>
 <span class="comment">/*-------------------------------[ History ]--------------------------------</span>
<span class="comment"> *</span>
<span class="comment"> * $Log: smb2_f601.c,v $</span>
<span class="comment"> * Revision 1.4  2007/01/24 11:38:14  DPfeuffer</span>
<span class="comment"> * prevents now to drive inputs</span>
<span class="comment"> *</span>
<span class="comment"> * Revision 1.3  2006/08/04 17:07:00  ts</span>
<span class="comment"> * #include &lt;stdlib.h&gt; to avoid implicit decl. warning of atoi()</span>
<span class="comment"> *</span>
<span class="comment"> * Revision 1.2  2006/08/03 13:54:10  DPfeuffer</span>
<span class="comment"> * cosmetics</span>
<span class="comment"> *</span>
<span class="comment"> * Revision 1.1  2006/05/31 08:22:24  DPfeuffer</span>
<span class="comment"> * Initial Revision</span>
<span class="comment"> *</span>
<span class="comment"> *---------------------------------------------------------------------------</span>
<span class="comment"> * (c) Copyright 2006 by MEN mikro elektronik GmbH, Nuernberg, Germany</span>
<span class="comment"> ****************************************************************************/</span>

<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/men_typs.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/mdis_api.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/usr_oss.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/usr_utl.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="smb2__api_8h.html">MEN/smb2_api.h</a>&gt;</span>
<span class="preprocessor">#include &lt;MEN/f601io.h&gt;</span>

<span class="comment">/*--------------------------------------+</span>
<span class="comment">|   PROTOTYPES                          |</span>
<span class="comment">+--------------------------------------*/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keywordtype">void</span>);
<span class="keyword">static</span> <span class="keywordtype">void</span> PrintIoNames( <span class="keywordtype">void</span> );
<span class="keyword">static</span> int32 PrintInStates( <span class="keywordtype">void</span> *smbHdl );
<span class="keyword">static</span> <span class="keywordtype">void</span> PrintError(<span class="keywordtype">char</span> *info, int32 errCode);

<span class="comment">/********************************* usage ***********************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keywordtype">void</span>)
{
    printf(<span class="stringliteral">"Usage: smb2_f601 [&lt;opts&gt;] &lt;device&gt; [&lt;opts&gt;]\n"</span>);
    printf(<span class="stringliteral">"Function: Control F601 I/Os\n"</span>);
    printf(<span class="stringliteral">"Options:\n"</span>);
    printf(<span class="stringliteral">"    device       device name                          \n"</span>);
    printf(<span class="stringliteral">"    -o=&lt;val&gt;     set outputs                          \n"</span>);         
    printf(<span class="stringliteral">"                   val = bit1:OUT2 | bit0:OUT1        \n"</span>);
    printf(<span class="stringliteral">"                   e.g. '2' or '0x02': OUT2=1, OUT1=0 \n"</span>);
    printf(<span class="stringliteral">"    -g           get state of inputs                  \n"</span>);
    printf(<span class="stringliteral">"    -l           loop until keypress:                 \n"</span>);
    printf(<span class="stringliteral">"                   toggle outputs get inputs          \n"</span>);
    printf(<span class="stringliteral">"\n"</span>);
    printf(<span class="stringliteral">"(c) 2006 by MEN mikro elektronik GmbH\n\n"</span>);
}

<span class="comment">/***************************************************************************/</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
    int32   n, err, ret=1;
    <span class="keywordtype">char</span>    *device, *str, *errstr, buf[40];
    int32   get, out, loop;
    <span class="keywordtype">void</span>    *smbHdl;
    u_int8  outVal;

    <span class="comment">/*----------------------+</span>
<span class="comment">    |  check arguments      |</span>
<span class="comment">    +----------------------*/</span>
    <span class="keywordflow">if</span>( (errstr = UTL_ILLIOPT(<span class="stringliteral">"o=gl?"</span>, buf)) ){
        printf(<span class="stringliteral">"*** %s\n"</span>, errstr);
        <span class="keywordflow">return</span>(1);
    }

    <span class="keywordflow">if</span>( UTL_TSTOPT(<span class="stringliteral">"?"</span>) ){
        usage();
        <span class="keywordflow">return</span>(1);
    }

    <span class="keywordflow">if</span>( argc &lt; 3 ){
        usage();
        <span class="keywordflow">return</span>(1);
    }
    
    <span class="comment">/*----------------------+</span>
<span class="comment">    |  get arguments        |</span>
<span class="comment">    +----------------------*/</span>
    <span class="keywordflow">for</span> (device=NULL, n=1; n&lt;argc; n++)
        <span class="keywordflow">if</span>( *argv[n] != <span class="charliteral">'-'</span> ){
            device = argv[n];
            <span class="keywordflow">break</span>;
        }

    <span class="keywordflow">if</span>( !device) {
        usage();
        <span class="keywordflow">return</span>(1);
    }

    out  = ((str = UTL_TSTOPT(<span class="stringliteral">"o="</span>)) ? atoi(str) : -1);
    <span class="keywordflow">if</span>( out != -1 ){
        <span class="comment">/* hex? */</span>
        <span class="keywordflow">if</span>( 0 == strncmp( str, <span class="stringliteral">"0x"</span>, 2 ))
            sscanf( str, <span class="stringliteral">"%x"</span>, &amp;out );
    }
    
    get  = (UTL_TSTOPT(<span class="stringliteral">"g"</span>) ? 1 : 0);
    loop = (UTL_TSTOPT(<span class="stringliteral">"l"</span>) ? 1 : 0);

    <span class="comment">/*----------------------+</span>
<span class="comment">    |  init SMB2 library    |</span>
<span class="comment">    +----------------------*/</span>
    err = <a name="a16"></a><a class="code" href="group____SMB2__API.html#a1">SMB2API_Init</a>( device, &amp;smbHdl );
    <span class="keywordflow">if</span>( err ){
        PrintError(<span class="stringliteral">"SMB2API_Init"</span>, err);
        <span class="keywordflow">return</span>(1);
    }

    <span class="keywordflow">if</span>( out != -1 ){
        <span class="comment">/*----------------------+</span>
<span class="comment">        |  set outputs          |</span>
<span class="comment">        +----------------------*/</span>
        err = <a name="a17"></a><a class="code" href="group____SMB2__API.html#a4">SMB2API_WriteByte</a>( smbHdl, 0, F601IO_ADDR,
                (u_int8)(out | F601IO_IN_MASK) );
        <span class="keywordflow">if</span>( err ){
            PrintError(<span class="stringliteral">"SMB2API_WriteByte"</span>, err);
            <span class="keywordflow">goto</span> ERR_EXIT;
        }
    }

    <span class="keywordflow">if</span>( get ){
        <span class="comment">/*----------------------+</span>
<span class="comment">        |  get input states     |</span>
<span class="comment">        +----------------------*/</span>
        PrintIoNames();
        <span class="keywordflow">if</span>( PrintInStates( smbHdl ) )
            <span class="keywordflow">goto</span> ERR_EXIT;
    }

    <span class="keywordflow">if</span>( loop ){
        <span class="comment">/*------------------------------+</span>
<span class="comment">        |  toggle outputs / get inputs  |</span>
<span class="comment">        +------------------------------*/</span>
        outVal = 0xff;

        <span class="comment">/* repeat until keypress */</span>
        <span class="keywordflow">do</span> {
            <span class="comment">/* toggle outputs */</span>
            err = <a class="code" href="group____SMB2__API.html#a4">SMB2API_WriteByte</a>( smbHdl, 0, F601IO_ADDR,
                (u_int8)(outVal | F601IO_IN_MASK) );
            <span class="keywordflow">if</span>( err ){
                PrintError(<span class="stringliteral">"SMB2API_WriteByte"</span>, err);
                <span class="keywordflow">goto</span> ERR_EXIT;
            }

            PrintIoNames();

            printf(<span class="stringliteral">"output state :  "</span>);
            <span class="keywordflow">for</span>( n=7; n&gt;=0; n-- ){
                <span class="keywordflow">if</span>( G_F601IO_tbl[n].dir != dirIn )
                    printf(<span class="stringliteral">"%d     "</span>, (outVal&gt;&gt;n)&amp;1 );
                <span class="keywordflow">else</span>
                    printf(<span class="stringliteral">"x     "</span>);
            }
            printf(<span class="stringliteral">"\n"</span>);

            <span class="comment">/* print input states */</span>
            <span class="keywordflow">if</span>( PrintInStates( smbHdl ) )
                <span class="keywordflow">goto</span> ERR_EXIT;

            outVal = ~outVal;

            UOS_Delay(2000);

        } <span class="keywordflow">while</span>( UOS_KeyPressed() == -1 );
    }

    ret = 0;

ERR_EXIT:
    <span class="comment">/*----------------------+</span>
<span class="comment">    |  exit SMB2 library    |</span>
<span class="comment">    +----------------------*/</span>
    err = <a name="a18"></a><a class="code" href="group____SMB2__API.html#a2">SMB2API_Exit</a>( &amp;smbHdl );
    <span class="keywordflow">if</span>( err ){
        PrintError(<span class="stringliteral">"SMB2API_Exit"</span>, err);
        ret = 1;
    }

    <span class="keywordflow">return</span> ret;
}

<span class="comment">/***************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> PrintIoNames( <span class="keywordtype">void</span> )
{
    int32   n;

    printf(<span class="stringliteral">"      i/o    : "</span>);
    <span class="keywordflow">for</span>( n=7; n&gt;=0; n-- )
        printf(<span class="stringliteral">"%s  "</span>, G_F601IO_tbl[n].name);
    printf(<span class="stringliteral">"\n"</span>);
}

<span class="comment">/***************************************************************************/</span>
<span class="keyword">static</span> int32 PrintInStates( <span class="keywordtype">void</span> *smbHdl )
{
    int32   err, n;
    u_int8  inVal;

    err = <a name="a19"></a><a class="code" href="group____SMB2__API.html#a5">SMB2API_ReadByte</a>( smbHdl, 0, F601IO_ADDR, &amp;inVal );
    <span class="keywordflow">if</span>( err ){
        PrintError(<span class="stringliteral">"SMB2API_ReadByte"</span>, err);
        <span class="keywordflow">return</span>(1);
    }

    printf(<span class="stringliteral">"input state  :  "</span>);
    <span class="keywordflow">for</span>( n=7; n&gt;=0; n-- ){
        <span class="keywordflow">if</span>( G_F601IO_tbl[n].dir != dirOut )
            printf(<span class="stringliteral">"%d     "</span>, (inVal&gt;&gt;n)&amp;1 );
        <span class="keywordflow">else</span>
            printf(<span class="stringliteral">"x     "</span>);
    }
    printf(<span class="stringliteral">"\n\n"</span>);

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/***************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> PrintError(<span class="keywordtype">char</span> *info, int32 errCode)
{
    <span class="keyword">static</span> <span class="keywordtype">char</span> errMsg[512];

    <span class="keywordflow">if</span>( !errCode )
        errCode = UOS_ErrnoGet();

    printf(<span class="stringliteral">"*** can't %s: %s\n"</span>, info, <a name="a20"></a><a class="code" href="group____SMB2__API.html#a16">SMB2API_Errstring</a>( errCode, errMsg ));
}

</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for SMB2_API using <a href="http://www.doxygen.org">doxygen</a>.<br>
	Copyright &copy; 2016 <a href="http://www.men.de">MEN Mikro Elektronik GmbH</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

