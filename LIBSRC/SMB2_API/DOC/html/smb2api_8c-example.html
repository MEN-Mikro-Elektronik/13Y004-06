<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - SMB2_API - Example Documentation</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;">
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">SMB2_API &nbsp; </h1>
	<h3>Example Documentation</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>smb2api.c</h1><div class="fragment"><pre><span class="comment">/*********************  P r o g r a m  -  M o d u l e ***********************/</span>
<span class="comment">/*</span>
<span class="comment"> *---------------------------------------------------------------------------</span>
<span class="comment"> * Copyright (c) 2019, MEN Mikro Elektronik GmbH</span>
<span class="comment"> ****************************************************************************/</span>
<span class="comment">/*</span>
<span class="comment">* This program is free software: you can redistribute it and/or modify</span>
<span class="comment">* it under the terms of the GNU General Public License as published by</span>
<span class="comment">* the Free Software Foundation, either version 2 of the License, or</span>
<span class="comment">* (at your option) any later version.</span>
<span class="comment">*</span>
<span class="comment">* This program is distributed in the hope that it will be useful,</span>
<span class="comment">* but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment">* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment">* GNU General Public License for more details.</span>
<span class="comment">*</span>
<span class="comment">* You should have received a copy of the GNU General Public License</span>
<span class="comment">* along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="comment">*/</span>

<span class="preprocessor">#include "smb2_ctrl.h"</span>
<span class="preprocessor">#include &lt;stdint.h&gt;</span>

<span class="comment">/*--------------------------------------+</span>
<span class="comment">|   DEFINES                             |</span>
<span class="comment">+--------------------------------------*/</span>
<span class="preprocessor">#define STR_XFER_LEN    20</span>
<span class="preprocessor"></span>
<span class="comment">/* Windows exclusive stuff to avoid compiler issues */</span>
<span class="preprocessor">#ifdef WINNT</span>
<span class="preprocessor"></span><span class="preprocessor">    #define snprintf _snprintf</span>
<span class="preprocessor"></span>    <span class="comment">/* still using deprecated functions like sscanf, sprintf,.. */</span>
<span class="preprocessor">    #pragma warning(disable:4996)</span>
<span class="preprocessor"></span><span class="preprocessor">    #define IGNORE_RET_VAL(fun) fun</span>
<span class="preprocessor"></span><span class="comment">/* non-Windows stuff to avoid compiler issues */</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    <span class="comment">/* Macro for ignoring the return value of a function (e.g. scanf) */</span>
<span class="preprocessor">    #ifndef IGNORE_RET_VAL</span>
<span class="preprocessor"></span><span class="preprocessor">        #define IGNORE_RET_VAL(fun) { if (fun); }</span>
<span class="preprocessor"></span><span class="preprocessor">    #endif</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">/*-----------------------------------------+</span>
<span class="comment">|  PROTOTYPES                              |</span>
<span class="comment">+-----------------------------------------*/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> AlertCbFunc( <span class="keywordtype">void</span> *cbArg );
<span class="preprocessor">#ifdef VXWORKS</span>
<span class="preprocessor"></span>    <span class="keyword">static</span> <span class="keywordtype">int</span> internFunc( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv );
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">/**********************************************************************/</span>
<span class="keyword">static</span> int32 AskUser(
    u_int32     *flags,
    u_int16     *addr,
    u_int8      *cmdAddr,
    u_int8      *byteData,
    u_int16     *wordData,
    u_int8      *readWrite
){
    u_int32 tmp;

<span class="preprocessor">#ifdef VXWORKS</span>
<span class="preprocessor"></span>    <span class="keywordtype">int</span> ac=0;
    <span class="keywordtype">char</span> *pc=NULL;
    <span class="comment">/* satisfy vxWorks compiler.. */</span>
    tmp = internFunc( ac, &amp;pc);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    
    <span class="keywordflow">if</span>( flags ){
        <span class="keywordflow">if</span>( SMB2CTRL_flag ){
            printf(<span class="stringliteral">" flags -&gt; 0x"</span>);
            fflush( stdin );
            IGNORE_RET_VAL(scanf(<span class="stringliteral">"%x"</span>, flags));
        }
        <span class="keywordflow">else</span>
            *flags = 0;
    }
    <span class="keywordflow">if</span>( addr ){
        printf(<span class="stringliteral">" device address -&gt; 0x"</span>);
        fflush( stdin );
        IGNORE_RET_VAL(scanf(<span class="stringliteral">"%x"</span>, &amp;tmp));
        *addr = (u_int16)tmp;
    }
    <span class="keywordflow">if</span>( cmdAddr ){
        printf(<span class="stringliteral">" device command or index value -&gt; 0x"</span>);
        fflush( stdin );
        IGNORE_RET_VAL(scanf(<span class="stringliteral">"%x"</span>, &amp;tmp));
        *cmdAddr = (u_int8)tmp;
    }
    <span class="keywordflow">if</span>( byteData ){
        printf(<span class="stringliteral">" byte to write -&gt; 0x"</span>);
        fflush( stdin );
        IGNORE_RET_VAL(scanf(<span class="stringliteral">"%x"</span>, &amp;tmp));
        *byteData = (u_int8)tmp;
    }
    <span class="keywordflow">if</span>( wordData ){
        printf(<span class="stringliteral">" word to write -&gt; 0x"</span>);
        fflush( stdin );
        IGNORE_RET_VAL(scanf(<span class="stringliteral">"%x"</span>, &amp;tmp));
        *wordData = (u_int16)tmp;
    }
    <span class="keywordflow">if</span>( readWrite ){
        <span class="keywordflow">do</span>{
            printf(<span class="stringliteral">" read or write (r/w) -&gt; "</span>);
            fflush( stdin );
            IGNORE_RET_VAL(scanf(<span class="stringliteral">"%c"</span>, (<span class="keywordtype">char</span>*)&amp;tmp));
            <span class="keywordflow">switch</span>( tmp ){
                <span class="keywordflow">case</span> <span class="charliteral">'r'</span>: *readWrite = <a class="code" href="smb2_8h.html#a9">SMB_READ</a>; <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">'w'</span>: *readWrite = <a class="code" href="smb2_8h.html#a10">SMB_WRITE</a>; <span class="keywordflow">break</span>;
            }
        } <span class="keywordflow">while</span>( *readWrite &gt; 1 );
    }
    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">static</span> int32 AskUserBlk(
    u_int8      *length,
    u_int8      *blkData )
{
    u_int8  n;
    u_int8  maxLength = *length;
    u_int32 tmp=0;

    printf(<span class="stringliteral">" number of bytes to write (1..%d)"</span>, maxLength);
    <span class="comment">/* limit user input */</span>
    <span class="keywordflow">do</span>{
        printf(<span class="stringliteral">" -&gt; "</span>);
        fflush( stdin );
        IGNORE_RET_VAL(scanf(<span class="stringliteral">"%d"</span>, &amp;tmp));
        *length = (u_int8)tmp;
    } <span class="keywordflow">while</span>( *length &gt; maxLength );
    
    <span class="keywordflow">for</span>( n=0; n &lt; *length; n++ ){
        printf(<span class="stringliteral">" blkData[%d] -&gt; 0x"</span>, n);
        fflush( stdin );
        IGNORE_RET_VAL(scanf(<span class="stringliteral">"%x"</span>, &amp;tmp));
        blkData[n] = (u_int8)tmp;
    }

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_QuickComm()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int8      rw;

    printf(<span class="stringliteral">"SMB2CTRL_QuickComm:\n"</span>);
    AskUser( &amp;flags, &amp;addr, 0, 0, 0, &amp;rw );

    <span class="keywordflow">return</span> <a name="a27"></a><a class="code" href="group____SMB2__API.html#a3">SMB2API_QuickComm</a>( SMB2CTRL_smbHdl, flags, addr, rw );
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_WriteByte()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int8      byteData;

    printf(<span class="stringliteral">"SMB2CTRL_WriteByte:\n"</span>);
    AskUser( &amp;flags, &amp;addr, 0, &amp;byteData, 0, 0 );

    <span class="keywordflow">return</span> <a name="a28"></a><a class="code" href="group____SMB2__API.html#a4">SMB2API_WriteByte</a>( SMB2CTRL_smbHdl, flags, addr, byteData );
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_ReadByte()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int8      byteData;
    int32       err;

    printf(<span class="stringliteral">"SMB2CTRL_ReadByte:\n"</span>);
    AskUser( &amp;flags, &amp;addr, 0, 0, 0, 0 );

    err = <a name="a29"></a><a class="code" href="group____SMB2__API.html#a5">SMB2API_ReadByte</a>( SMB2CTRL_smbHdl, flags, addr, &amp;byteData );
    <span class="keywordflow">if</span>( err )
        <span class="keywordflow">return</span> err;

    printf(<span class="stringliteral">" read byte: 0x%02x\n"</span>, byteData);

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_WriteByteData()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int8      cmdAddr;
    u_int8      byteData;

    printf(<span class="stringliteral">"SMB2CTRL_WriteByteData:\n"</span>);
    AskUser( &amp;flags, &amp;addr, &amp;cmdAddr, &amp;byteData, 0, 0 );

    <span class="keywordflow">return</span> <a name="a30"></a><a class="code" href="group____SMB2__API.html#a6">SMB2API_WriteByteData</a>( SMB2CTRL_smbHdl, flags, addr, cmdAddr, byteData );
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_ReadByteData()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int8      cmdAddr;
    u_int8      byteData;
    int32       err;

    printf(<span class="stringliteral">"SMB2CTRL_ReadByteData:\n"</span>);
    AskUser( &amp;flags, &amp;addr, &amp;cmdAddr, 0, 0, 0 );

    err = <a name="a31"></a><a class="code" href="group____SMB2__API.html#a7">SMB2API_ReadByteData</a>( SMB2CTRL_smbHdl, flags, addr, cmdAddr, &amp;byteData );
    <span class="keywordflow">if</span>( err )
        <span class="keywordflow">return</span> err;

    printf(<span class="stringliteral">" read byte: 0x%02x\n"</span>, byteData);

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_WriteWordData()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int8      cmdAddr;
    u_int16     wordData;

    printf(<span class="stringliteral">"SMB2CTRL_WriteWordData:\n"</span>);
    AskUser( &amp;flags, &amp;addr, &amp;cmdAddr, 0, &amp;wordData, 0 );

    <span class="keywordflow">return</span> <a name="a32"></a><a class="code" href="group____SMB2__API.html#a8">SMB2API_WriteWordData</a>( SMB2CTRL_smbHdl, flags, addr, cmdAddr, wordData );
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_ReadWordData()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int8      cmdAddr;
    u_int16     wordData;
    int32       err;

    printf(<span class="stringliteral">"SMB2CTRL_ReadWordData:\n"</span>);
    AskUser( &amp;flags, &amp;addr, &amp;cmdAddr, 0, 0, 0 );

    err = <a name="a33"></a><a class="code" href="group____SMB2__API.html#a9">SMB2API_ReadWordData</a>( SMB2CTRL_smbHdl, flags, addr, cmdAddr, &amp;wordData );
    <span class="keywordflow">if</span>( err )
        <span class="keywordflow">return</span> err;

    printf(<span class="stringliteral">" read word: 0x%04x\n"</span>, wordData);

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_WriteBlockData()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int8      cmdAddr;
    u_int8      length=<a class="code" href="smb2_8h.html#a60">SMB_BLOCK_MAX_BYTES</a>;
    u_int8      blkData[<a class="code" href="smb2_8h.html#a60">SMB_BLOCK_MAX_BYTES</a>];

    printf(<span class="stringliteral">"SMB2CTRL_WriteBlockData:\n"</span>);
    AskUser( &amp;flags, &amp;addr, &amp;cmdAddr, 0, 0, 0 );
    AskUserBlk( &amp;length, blkData );

    <span class="keywordflow">return</span> <a name="a34"></a><a class="code" href="group____SMB2__API.html#a10">SMB2API_WriteBlockData</a>( SMB2CTRL_smbHdl, flags, addr, cmdAddr, length, blkData );
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_ReadBlockData()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int8      cmdAddr;
    u_int8      length;
    u_int8      blkData[<a class="code" href="smb2_8h.html#a60">SMB_BLOCK_MAX_BYTES</a>];
    int32       err;

    printf(<span class="stringliteral">"SMB2CTRL_ReadBlockData:\n"</span>);
    AskUser( &amp;flags, &amp;addr, &amp;cmdAddr, 0, 0, 0 );

    err = <a name="a35"></a><a class="code" href="group____SMB2__API.html#a11">SMB2API_ReadBlockData</a>( SMB2CTRL_smbHdl, flags, addr, cmdAddr, &amp;length, blkData );
    <span class="keywordflow">if</span>( err )
        <span class="keywordflow">return</span> err;

    UTL_Memdump(<span class="stringliteral">"Read data"</span>, (<span class="keywordtype">char</span>*)blkData, length, 1);

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_ProcessCall()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int8      cmdAddr;
    u_int16     wordData;
    int32       err;

    printf(<span class="stringliteral">"SMB2CTRL_ProcessCall:\n"</span>);
    AskUser( &amp;flags, &amp;addr, &amp;cmdAddr, 0, &amp;wordData, 0 );

    err = <a name="a36"></a><a class="code" href="group____SMB2__API.html#a12">SMB2API_ProcessCall</a>( SMB2CTRL_smbHdl, flags, addr, cmdAddr, &amp;wordData );
    <span class="keywordflow">if</span>( err )
        <span class="keywordflow">return</span> err;

    printf(<span class="stringliteral">" read word: 0x%04x\n"</span>, wordData);

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_BlockProcessCall()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int8      cmdAddr;
    u_int8      readLen;
    u_int8      writeLen=<a class="code" href="smb2_8h.html#a60">SMB_BLOCK_MAX_BYTES</a>;
    u_int8      writeData[<a class="code" href="smb2_8h.html#a60">SMB_BLOCK_MAX_BYTES</a>];
    u_int8      readData[<a class="code" href="smb2_8h.html#a60">SMB_BLOCK_MAX_BYTES</a>];
    int32       err;

    printf(<span class="stringliteral">"SMB2CTRL_BlockProcessCall:\n"</span>);
    AskUser( &amp;flags, &amp;addr, &amp;cmdAddr, 0, 0, 0 );
    AskUserBlk( &amp;writeLen, writeData );

    err = <a name="a37"></a><a class="code" href="group____SMB2__API.html#a13">SMB2API_BlockProcessCall</a>( SMB2CTRL_smbHdl, flags, addr, cmdAddr,
            writeLen, writeData, &amp;readLen, readData );
    <span class="keywordflow">if</span>( err )
        <span class="keywordflow">return</span> err;

    UTL_Memdump(<span class="stringliteral">"Read data"</span>, (<span class="keywordtype">char</span>*)readData, readLen, 1);

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_I2CXfer()
{
    <span class="keywordtype">int</span> num, n, size;
    u_int8  length;
    <span class="keywordtype">char</span>    str[STR_XFER_LEN];
    int32   err=1;
    <a name="_a38"></a><a class="code" href="structI2CMESSAGE.html">SMB_I2CMESSAGE</a> *msg=NULL;

    printf(<span class="stringliteral">"SMB2CTRL_I2CXfer:\n"</span>);
    
    printf(<span class="stringliteral">" number of I2C messages to transfer -&gt; "</span>);
    fflush( stdin );
    IGNORE_RET_VAL(scanf(<span class="stringliteral">"%d"</span>, &amp;num));

    <span class="keywordflow">if</span> ( (num &lt;=0 ) || (num &gt; 1024) ) {
        printf(<span class="stringliteral">"*** # of messages too high, max. is 1024.\n"</span>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="comment">/* alloc buffer (data buffer limited to 128 bytes) */</span>
    size = num * (<span class="keyword">sizeof</span>(SMB_I2CMESSAGE) +  <a class="code" href="smb2_8h.html#a61">I2C_BLOCK_MAX_BYTES</a>);
    <span class="keywordflow">if</span>( (msg = (<a class="code" href="structI2CMESSAGE.html">SMB_I2CMESSAGE</a>*)malloc( size )) == NULL)
        <span class="keywordflow">goto</span> ERR_EXIT;

    <span class="comment">/* create the messages */</span>
    <span class="keywordflow">for</span>( n=0; n&lt;num; n++ ){

        printf(<span class="stringliteral">"--- Message #%d ---\n"</span>, n);

        AskUser( (u_int32*)&amp;msg[n].flags, (u_int16*)&amp;msg[n].addr, 0, 0, 0, 0 );

        <span class="comment">/* set buffer pointer behind the SMB_I2CMESSAGE struct */</span>
        msg[n].<a name="a39"></a><a class="code" href="structI2CMESSAGE.html#m3">buf</a> = (u_int8*)(&amp;msg[n]) + <span class="keyword">sizeof</span>(SMB_I2CMESSAGE);

        length = <a class="code" href="smb2_8h.html#a61">I2C_BLOCK_MAX_BYTES</a>; 
        AskUserBlk( &amp;length, msg[n].buf );

        msg[n].<a name="a40"></a><a class="code" href="structI2CMESSAGE.html#m2">len</a> = length;
    }

    err = <a name="a41"></a><a class="code" href="group____SMB2__API.html#a15">SMB2API_I2CXfer</a>( SMB2CTRL_smbHdl, msg, num );
    <span class="keywordflow">if</span>( err )
        <span class="keywordflow">goto</span> ERR_EXIT;

    <span class="comment">/* dump messages */</span>
    <span class="keywordflow">for</span>( n=0; n&lt;num; n++ ){
        snprintf( str, (size_t)STR_XFER_LEN ,<span class="stringliteral">"Message #%d"</span>, n);
        UTL_Memdump( str, (<span class="keywordtype">char</span>*)(msg[n].buf), msg[n].len, 1);
    }

ERR_EXIT:
    <span class="keywordflow">if</span>( msg )
        free(msg);

    <span class="keywordflow">return</span> err;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_Errstring()
{
    int32       errCode;
    <span class="keyword">static</span> <span class="keywordtype">char</span> errMsg[512];

    printf(<span class="stringliteral">"SMB2CTRL_Errstring:\n"</span>);

    printf(<span class="stringliteral">" error code -&gt; 0x"</span>);
    fflush( stdin );
    IGNORE_RET_VAL(scanf(<span class="stringliteral">"%x"</span>, &amp;errCode));

    printf(<span class="stringliteral">" %s\n"</span>, <a name="a42"></a><a class="code" href="group____SMB2__API.html#a16">SMB2API_Errstring</a>( errCode, errMsg ));

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_Ident()
{
    printf(<span class="stringliteral">"SMB2CTRL_Ident:\n"</span>);

    printf(<span class="stringliteral">"%s\n"</span>, <a name="a43"></a><a class="code" href="group____SMB2__API.html#a0">SMB2API_Ident</a>() );

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_AlertResponse()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int16     alertCnt;
    int32       err;

    printf(<span class="stringliteral">"SMB2CTRL_AlertResponse:\n"</span>);
    AskUser( &amp;flags, &amp;addr, 0, 0, 0, 0 );

    err = <a name="a44"></a><a class="code" href="group____SMB2__API.html#a17">SMB2API_AlertResponse</a>( SMB2CTRL_smbHdl, flags, addr, &amp;alertCnt );
    <span class="keywordflow">if</span>( err )
        <span class="keywordflow">return</span> err;

    printf(<span class="stringliteral">" received alerts: %d\n"</span>, alertCnt);

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_AlertCbInstall()
{
    u_int16     addr=0;

    printf(<span class="stringliteral">"SMB2CTRL_AlertCbInstall:\n"</span>);
    AskUser( 0, &amp;addr, 0, 0, 0, 0 );
    printf(<span class="stringliteral">" alertCallCount=%u\n"</span>, SMB2CTRL_alertCallCount);

    <span class="keywordflow">return</span> <a name="a45"></a><a class="code" href="group____SMB2__API.html#a18">SMB2API_AlertCbInstall</a>( SMB2CTRL_smbHdl, addr, AlertCbFunc,
                (<span class="keywordtype">void</span>*)(INT32_OR_64)addr );

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_AlertCbInstallSig()
{
    u_int16     addr=0;
    u_int32     sigCode=0;

    printf(<span class="stringliteral">"SMB2CTRL_AlertCbInstallSig:\n"</span>);
    AskUser( 0, &amp;addr, 0, 0, 0, 0 );

    printf(<span class="stringliteral">" UOS_SIG signal code to use for alert -&gt; 0x"</span>);
    fflush( stdin );
    IGNORE_RET_VAL(scanf(<span class="stringliteral">"%x"</span>, &amp;sigCode));
    
    printf(<span class="stringliteral">" alertCallCount=%u\n"</span>, SMB2CTRL_alertCallCount);

    <span class="keywordflow">return</span> <a name="a46"></a><a class="code" href="group____SMB2__API.html#a19">SMB2API_AlertCbInstallSig</a>( SMB2CTRL_smbHdl, addr, AlertCbFunc,
                                      (<span class="keywordtype">void</span>*)(INT32_OR_64)addr, sigCode );
    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_AlertCbRemove()
{
    u_int16     addr=0;
    u_int32     cbArg;
    int32       err;

    printf(<span class="stringliteral">"SMB2CTRL_AlertCbRemove:\n"</span>);
    AskUser( 0, &amp;addr, 0, 0, 0, 0 );

    err = <a name="a47"></a><a class="code" href="group____SMB2__API.html#a20">SMB2API_AlertCbRemove</a>( SMB2CTRL_smbHdl, addr, (<span class="keywordtype">void</span>**)&amp;cbArg );
    <span class="keywordflow">if</span>( err )
        <span class="keywordflow">return</span> err;

    printf(<span class="stringliteral">" cbArg=0x%x (should be the address)\n"</span>, cbArg);
    printf(<span class="stringliteral">" alertCallCount=%u\n"</span>, SMB2CTRL_alertCallCount);

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> AlertCbFunc( <span class="keywordtype">void</span> *cbArg )
{
    u_int32     addr;

    SMB2CTRL_alertCallCount++;

    addr = (u_int32)(uintptr_t)cbArg;
    printf(<span class="stringliteral">"&gt;&gt;&gt; AlertCbFunc called with cbArg=0x%x, alertCallCount=%u\n"</span>,
        addr, SMB2CTRL_alertCallCount );
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_Mtest()
{
    u_int32     flags=0;
    u_int16     addr=0;
    u_int8      cmdAddrStart=0, cmdAddr=0;
    int32       err=0;
    u_int8      bytes, words, n;
    u_int8      bytePat, byteRead;
    u_int16     wordPat, wordRead;
    u_int32     errCount;
    u_int32     tmp=0;
    <span class="keywordtype">char</span>        errMsg[512];

    printf(<span class="stringliteral">"Simple memory test:\n"</span>);

    AskUser( &amp;flags, &amp;addr, 0, 0, 0, 0 );

    printf(<span class="stringliteral">" offset to begin (index value, 0x00..0xff) -&gt; 0x"</span>);
    fflush( stdin );
    IGNORE_RET_VAL(scanf(<span class="stringliteral">"%x"</span>, &amp;tmp));
    cmdAddrStart = (u_int8)tmp;

    printf(<span class="stringliteral">" number of bytes to transfer (0x00..0xff) -&gt; 0x"</span>);
    fflush( stdin );
    IGNORE_RET_VAL(scanf(<span class="stringliteral">"%x"</span>, &amp;tmp));
    bytes = (u_int8)tmp;
    words = bytes/2;

    <span class="comment">/*-----------------------------------------+</span>
<span class="comment">    |  Write/SMB2CTRL_ReadByteData test                 |</span>
<span class="comment">    +-----------------------------------------*/</span>
    errCount=0;
    printf(<span class="stringliteral">"\n - SMB2CTRL_WriteByteData( hdl, flags, 0x%x, 0x%x..0x%x, byte ):\n"</span>,
        addr, cmdAddrStart, cmdAddrStart+bytes);
    printf(<span class="stringliteral">"   byte:"</span>);
    <span class="keywordflow">for</span>( n=0; n&lt;bytes; n++ ){
        bytePat = n+1;
        printf(<span class="stringliteral">" 0x%02x"</span>, bytePat);
        cmdAddr = cmdAddrStart + n;
        err = <a class="code" href="group____SMB2__API.html#a6">SMB2API_WriteByteData</a>( SMB2CTRL_smbHdl, flags, addr, cmdAddr, bytePat );
        <span class="keywordflow">if</span>( err ){
            printf(<span class="stringliteral">"\n\007 *** failed: SMB2CTRL_WriteByteData( hdl, flags, 0x%x, 0x%x, 0x%x )\n"</span>,
                addr, cmdAddr, bytePat);            
            printf(<span class="stringliteral">" %s\n"</span>, <a class="code" href="group____SMB2__API.html#a16">SMB2API_Errstring</a>( err, errMsg ));
            errCount++;
            <span class="keywordflow">break</span>;
        }
        UOS_Delay(20);
    }

    printf(<span class="stringliteral">"\n - SMB2CTRL_ReadByteData( hdl, flags, 0x%x, 0x%x..0x%x, byte ), verify:\n"</span>,
        addr, cmdAddrStart, cmdAddrStart+bytes);
    <span class="keywordflow">for</span>( n=0; n&lt;bytes; n++ ){
        bytePat = n+1;
        cmdAddr = cmdAddrStart + n;
        err = <a class="code" href="group____SMB2__API.html#a7">SMB2API_ReadByteData</a>( SMB2CTRL_smbHdl, flags, addr, cmdAddr, &amp;byteRead );
        <span class="keywordflow">if</span>( err ){
            printf(<span class="stringliteral">" *** SMB2CTRL_ReadByteData( hdl, flags, 0x%x, 0x%x, &amp;byte ) failed\n"</span>,
                addr, cmdAddr);
            printf(<span class="stringliteral">" %s\n"</span>, <a class="code" href="group____SMB2__API.html#a16">SMB2API_Errstring</a>( err, errMsg ));
            errCount++;
            <span class="keywordflow">break</span>;
        }
        <span class="keywordflow">if</span>( bytePat != byteRead ){
            printf(<span class="stringliteral">" *** index=0x%02x: written byte 0x%02x != read byte 0x%02x\n"</span>,
                cmdAddr, bytePat, byteRead);
            errCount++;
        }
    }

    <span class="keywordflow">if</span>( errCount ){
        printf(<span class="stringliteral">" =&gt; *** Write/SMB2CTRL_ReadByteData test failed\n"</span>);
        SMB2CTRL_errCount++;
    }
    <span class="keywordflow">else</span> {
        printf(<span class="stringliteral">" =&gt; Write/SMB2CTRL_ReadByteData test passed\n"</span>);
    }

    <span class="comment">/*-----------------------------------------+</span>
<span class="comment">    |  Write/SMB2CTRL_ReadWordData test        |</span>
<span class="comment">    +-----------------------------------------*/</span>
    errCount=0;
    printf(<span class="stringliteral">"\n - SMB2CTRL_WriteWordData( hdl, flags, 0x%x, 0x%x..0x%x, word ):\n"</span>,
        addr, cmdAddrStart, cmdAddrStart+words);
    printf(<span class="stringliteral">"   word:"</span>);
    <span class="keywordflow">for</span>( n=0; n&lt;words; n+=2 ){
        bytePat = n+1;
        wordPat = (0xff00 &amp; (((u_int16)(bytePat))&lt;&lt;8)) |
                  (0x00ff &amp; (u_int16)(~bytePat));
        printf(<span class="stringliteral">" 0x%04x"</span>, wordPat);
        cmdAddr = cmdAddrStart + n;
        err = <a class="code" href="group____SMB2__API.html#a8">SMB2API_WriteWordData</a>( SMB2CTRL_smbHdl, flags, addr, cmdAddr, wordPat );
        <span class="keywordflow">if</span>( err ){
            printf(<span class="stringliteral">"\n\007 *** failed: SMB2CTRL_WriteWordData( hdl, flags, 0x%x, 0x%x, 0x%x )\n"</span>,
                addr, cmdAddr, wordPat);
            printf(<span class="stringliteral">" %s\n"</span>, <a class="code" href="group____SMB2__API.html#a16">SMB2API_Errstring</a>( err, errMsg ));
            errCount++;
            <span class="keywordflow">break</span>;
        }
        UOS_Delay(20);
    }

    printf(<span class="stringliteral">"\n - SMB2CTRL_ReadWordData( hdl, flags, 0x%x, 0x%x..0x%x, word ), verify:\n"</span>,
        addr, cmdAddrStart, cmdAddrStart+words);
    <span class="keywordflow">for</span>( n=0; n&lt;words; n+=2 ){
        bytePat = n+1;
        wordPat = (0xff00 &amp; (((u_int16)(bytePat))&lt;&lt;8)) |
                  (0x00ff &amp; (u_int16)(~bytePat));
        cmdAddr = cmdAddrStart + n;
        err = <a class="code" href="group____SMB2__API.html#a9">SMB2API_ReadWordData</a>( SMB2CTRL_smbHdl, flags, addr, cmdAddr, &amp;wordRead );
        <span class="keywordflow">if</span>( err ){
            printf(<span class="stringliteral">" *** SMB2CTRL_ReadWordData( hdl, flags, 0x%x, 0x%x, &amp;word ) failed\n"</span>,
                addr, cmdAddr);
            printf(<span class="stringliteral">" %s\n"</span>, <a class="code" href="group____SMB2__API.html#a16">SMB2API_Errstring</a>( err, errMsg ));
            errCount++;
            <span class="keywordflow">break</span>;
        }
        <span class="keywordflow">if</span>( wordPat != wordRead ){
            printf(<span class="stringliteral">" *** index=0x%02x: written word 0x%04x != read word 0x%04x\n"</span>,
                cmdAddr, wordPat, wordRead);
            errCount++;
        }
    }

    <span class="keywordflow">if</span>( errCount ){
        printf(<span class="stringliteral">" =&gt; *** Write/SMB2CTRL_ReadWordData test failed\n"</span>);
        SMB2CTRL_errCount++;
    }
    <span class="keywordflow">else</span> {
        printf(<span class="stringliteral">" =&gt; Write/SMB2CTRL_ReadWordData test passed\n"</span>);
    }

    <span class="keywordflow">return</span> -1;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_List()
{
    u_int16 addr;
    u_int8  byte;
    int32   err;

    printf(<span class="stringliteral">"SMB2CTRL_List all available SMB devices:\n"</span>);

    <span class="keywordflow">for</span>( addr=0x0; addr&lt;0xff; addr+=2 ) {
        err = <a class="code" href="group____SMB2__API.html#a5">SMB2API_ReadByte</a>( SMB2CTRL_smbHdl, 0, addr, &amp;byte );
        <span class="comment">/* device present? */</span> 
        <span class="keywordflow">if</span>( (err != <a class="code" href="group____SMB2__ERR.html#a4">SMB_ERR_ADDR</a>) &amp;&amp; (err != <a class="code" href="group____SMB2__ERR.html#a7">SMB_ERR_NO_DEVICE</a>) ) {
            printf(<span class="stringliteral">"- 0x%02x"</span>, addr);
            <span class="keywordflow">switch</span>( err ){
                <span class="keywordflow">case</span> <a class="code" href="group____SMB2__ERR.html#a1">SMB_ERR_NO</a>:
                    printf(<span class="stringliteral">" (read-byte=0x%x)\n"</span>, byte);
                    <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <a class="code" href="group____SMB2__ERR.html#a14">SMB_ERR_ADDR_EXCLUDED</a>:
                    printf(<span class="stringliteral">" (device not checked - excluded in descriptor)\n"</span>);
                    <span class="keywordflow">break</span>;
                <span class="keywordflow">default</span>:
                {
                    <span class="keyword">static</span> <span class="keywordtype">char</span> errMsg[512];
                    printf(<span class="stringliteral">" %s\n"</span>, <a class="code" href="group____SMB2__API.html#a16">SMB2API_Errstring</a>( err, errMsg ));
                }
            } <span class="comment">/* switch */</span>
        }
    }<span class="comment">/* for */</span>

    <span class="keywordflow">return</span> -1;
}

<span class="preprocessor">#ifdef VXWORKS</span>
<span class="preprocessor"></span>    <span class="comment">/* dummy to satisfy compiler, unused */</span>
    <span class="keyword">static</span> <span class="keywordtype">int</span> internFunc( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv )
    {
        <span class="keywordflow">return</span> 0;
    }
<span class="preprocessor">#endif</span>
</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for SMB2_API using <a href="http://www.doxygen.org">doxygen</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

