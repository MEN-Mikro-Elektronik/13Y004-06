<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - SMB2_API - Example Documentation</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;">
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">SMB2_API &nbsp; </h1>
	<h3>Example Documentation</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>smb2_ctrl.c</h1><div class="fragment"><pre><span class="comment">/*********************  P r o g r a m  -  M o d u l e ***********************/</span>
<span class="comment">/*</span>
<span class="comment"> *---------------------------------------------------------------------------</span>
<span class="comment"> * Copyright (c) 2019, MEN Mikro Elektronik GmbH</span>
<span class="comment"> ****************************************************************************/</span>
<span class="comment">/*</span>
<span class="comment">* This program is free software: you can redistribute it and/or modify</span>
<span class="comment">* it under the terms of the GNU General Public License as published by</span>
<span class="comment">* the Free Software Foundation, either version 2 of the License, or</span>
<span class="comment">* (at your option) any later version.</span>
<span class="comment">*</span>
<span class="comment">* This program is distributed in the hope that it will be useful,</span>
<span class="comment">* but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment">* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment">* GNU General Public License for more details.</span>
<span class="comment">*</span>
<span class="comment">* You should have received a copy of the GNU General Public License</span>
<span class="comment">* along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="comment">*/</span>

<span class="preprocessor">#include "smb2_ctrl.h"</span>
<span class="preprocessor">#include "cmd_tbl.h"</span>

<span class="comment">/*</span>
<span class="comment"> * Macro for ignoring the return value of a function (e.g. scanf)</span>
<span class="comment"> */</span>
<span class="preprocessor">#ifndef IGNORE_RET_VAL</span>
<span class="preprocessor"></span><span class="preprocessor">#define IGNORE_RET_VAL(fun) { if (fun); }</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">/*--------------------------------------+</span>
<span class="comment">|   GLOBALS                             |</span>
<span class="comment">+--------------------------------------*/</span>
<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> IdentString[]=MENT_XSTR(MAK_REVISION);
<span class="keyword">static</span> <span class="keywordtype">char</span> *G_dev;
<span class="keyword">static</span> <span class="keywordtype">char</span> *G_cmd;
u_int32     SMB2CTRL_errCount;
u_int32     SMB2CTRL_alertCallCount;
<span class="keywordtype">void</span>        *SMB2CTRL_smbHdl;
u_int8      SMB2CTRL_flag;

<span class="comment">/*--------------------------------------+</span>
<span class="comment">|   PROTOTYPES                          |</span>
<span class="comment">+--------------------------------------*/</span>
<span class="keyword">static</span> int32 Dispatch(<span class="keywordtype">void</span>);

<span class="preprocessor">#define CMD_LEN         10</span>
<span class="preprocessor"></span><span class="preprocessor">#define INPUT_BUF_LEN   1024  </span><span class="comment">/* much larger than cmd buf */</span>


<span class="comment">/**********************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keywordtype">void</span>)
{
    printf( <span class="stringliteral">"\n"</span>
        <span class="stringliteral">"Usage   : smb2_ctrl &lt;devName&gt; [&lt;-f&gt;] [&lt;command&gt;] [&lt;opts&gt;]     \n"</span>
        <span class="stringliteral">"Function: Access SMBus devices                                \n"</span>
        <span class="stringliteral">"Options:\n"</span>
        <span class="stringliteral">"    devName : SMB2 device name e.g. smb2_1                    \n"</span>
        <span class="stringliteral">"+---------------------------------------------------------+\n"</span>
        <span class="stringliteral">"| If you specify a command, the tool operates in Command  |\n"</span>
        <span class="stringliteral">"| Mode (e.g. for scripting). Otherwise, the tool provides |\n"</span>
        <span class="stringliteral">"| a Command Line Interface with extended functionality.   |\n"</span>
        <span class="stringliteral">"+---------------------------------------------------------+\n"</span>
        <span class="stringliteral">"Command Mode:\n"</span>
        <span class="stringliteral">"    list : List SMB devices that accepts ReadByte commands.   \n"</span>
        <span class="stringliteral">"           A few SMB devices accepts ReadByte commands only   \n"</span>
        <span class="stringliteral">"           after other commands or not at all.                \n"</span>
                <span class="stringliteral">"                  wb  : WriteByte       rb  : ReadByte     \n"</span>
                <span class="stringliteral">"                  wbd : WriteByteData   rbd : ReadByteData \n"</span>
                <span class="stringliteral">"                  wwd : WriteWordData   rwd : ReadWordData \n"</span>
        <span class="stringliteral">"    rbk  : ReadBlockData       wbk  : WriteBlockData          \n"</span>
        <span class="stringliteral">"    pc   : ProcessCall         q    : QuickComm               \n"</span>
        <span class="stringliteral">"Command Mode Options:\n"</span>
        <span class="stringliteral">"    [-r]      : read access for QuickComm                     \n"</span>
        <span class="stringliteral">"    [-F=hex]  : set SMB flags (default=0x00)                  \n"</span>
        <span class="stringliteral">"    [-a=hex]  : address of SMB2 device                        \n"</span>
        <span class="stringliteral">"    [-o=hex]  : offset (default=0)                            \n"</span>
        <span class="stringliteral">"    [-d=hex]  : data to write (non-block access - wbd/wwd)    \n"</span>
        <span class="stringliteral">"    [hex ..]  : data to write (block access - wbk)            \n"</span>
        <span class="stringliteral">"    [-n=hex]  : number of bytes for memory dump               \n"</span>
        <span class="stringliteral">"CLI Mode Options:\n"</span>
        <span class="stringliteral">"    &lt;-f&gt;      : ask for flags                                 \n"</span>
                <span class="stringliteral">"Calling examples:\n"</span>
        <span class="stringliteral">"  _____Command Mode_____                                      \n"</span>
        <span class="stringliteral">"  - write byte:\n"</span>
                <span class="stringliteral">"    smb2_ctrl smb2_1 wbd -a=0xac -o=5 -d=0x12 \n"</span>
        <span class="stringliteral">"  - read 128 bytes:\n"</span>
        <span class="stringliteral">"    smb2_ctrl smb2_1 rbd -a=0xae -n=0x80\n"</span>
        <span class="stringliteral">"  - block write 3 bytes to offset 0x5:\n"</span>
        <span class="stringliteral">"    smb2_ctrl smb2_1 wbk -a=0xae -o=0x05 0xaa 0xff 0xee\n"</span>
        <span class="stringliteral">"  _____CLI Mode_____                                          \n"</span>
        <span class="stringliteral">"  - execute CLI Mode:\n"</span>
        <span class="stringliteral">"    smb2_ctrl smb2_1\n\n"</span>
        <span class="stringliteral">"+------------------------------------------------------+\n"</span>
        <span class="stringliteral">"!! Please be careful when you write to SMBus devices. !!\n"</span>
        <span class="stringliteral">"!! Otherwise you may destroy important data (e.g. on  !!\n"</span>
        <span class="stringliteral">"!! EEPROMs) or you may cause damage to the HW.        !!\n"</span>
        <span class="stringliteral">"+------------------------------------------------------+\n"</span>);
    printf(<span class="stringliteral">"\nCopyright (c) 2019, MEN Mikro Elektronik GmbH\n%s\n\n"</span>, IdentString);
}

<span class="comment">/**********************************************************************/</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])
{
    int32   ret=0, err=0;
    int32   smbAddr=0x0;
    u_int32 flags=0x0;
    u_int32 wordData=0;
    u_int32 byteData=0;
    u_int32 offs=0;
    u_int32 tmp=0;
    int32   i=0;
    int32   num=0;
    u_int8  readwrite;
    u_int8  length=0;
    u_int8  max_length = <a class="code" href="smb2_8h.html#a60">SMB_BLOCK_MAX_BYTES</a>;
    u_int8  blkData[<a class="code" href="smb2_8h.html#a60">SMB_BLOCK_MAX_BYTES</a>]={0};
    <span class="keywordtype">char</span>    *errstr=NULL, ebuf[100];
    <span class="keywordtype">char</span>    *optP=NULL;

    <span class="comment">/* init globals */</span>
    SMB2CTRL_flag = 0;
    SMB2CTRL_errCount = 0;
    SMB2CTRL_alertCallCount = 0;
    G_dev = NULL;
    G_cmd = NULL;

    <span class="comment">/*------------------+</span>
<span class="comment">    |  Check arguments  |</span>
<span class="comment">    +------------------*/</span>
    errstr = UTL_ILLIOPT( <span class="stringliteral">"?fra=o=d=n=F="</span>, ebuf );
    <span class="keywordflow">if</span>( errstr ) {
        printf( <span class="stringliteral">"*** %s\n"</span>, errstr );
        usage();
        <span class="keywordflow">return</span> 1;
    }
    <span class="keywordflow">if</span>( UTL_TSTOPT(<span class="stringliteral">"?"</span>) ) {
        usage();
        <span class="keywordflow">return</span> 0;
    }

    <span class="comment">/*----------------+</span>
<span class="comment">    |  Get arguments  |</span>
<span class="comment">    +----------------*/</span>
    <span class="keywordflow">for</span>( i=1; i&lt;argc; i++ ) {
        <span class="keywordflow">if</span>( *argv[i] != <span class="charliteral">'-'</span> ) {
            <span class="keywordflow">if</span>( G_dev == NULL ) {
                G_dev = argv[i];
            }
            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( G_cmd == NULL ) {
                G_cmd = argv[i];
                <span class="keywordflow">break</span>;
            }
        }
    }
    <span class="keywordflow">if</span>( !G_dev ) {
        usage();
        <span class="keywordflow">return</span> 0;
    }

    <span class="comment">/*--------------------+</span>
<span class="comment">    |  init library       |</span>
<span class="comment">    +--------------------*/</span>
    err = <a name="a4"></a><a class="code" href="group____SMB2__API.html#a1">SMB2API_Init</a>( G_dev, &amp;SMB2CTRL_smbHdl );
    <span class="keywordflow">if</span>( err ){
        SMB2CTRL_PrintStatus(err);
        ret=1;
        <span class="keywordflow">goto</span> EXIT;
    }

    <span class="comment">/*--------------------------+</span>
<span class="comment">    | User mode                 |</span>
<span class="comment">    +--------------------------*/</span>
    <span class="keywordflow">if</span>( G_cmd == NULL ) {
        
        SMB2CTRL_flag  = ( UTL_TSTOPT(<span class="stringliteral">"f"</span>) ? 1 : 0 );    <span class="comment">/* ask for SMB flag */</span>
        
        SMB2CTRL_CmdHelp();
    
        <span class="comment">/* enter command dispatcher */</span>
        Dispatch();

    }
    <span class="comment">/*--------------------------+</span>
<span class="comment">    | Command mode              |</span>
<span class="comment">    +--------------------------*/</span>
    <span class="keywordflow">else</span>{
        <span class="keywordflow">if</span>( UTL_TSTOPT(<span class="stringliteral">"f"</span>) ) {
            printf( <span class="stringliteral">"*** You are in Command Mode! Please use param. -F= if you need to use flags!\n"</span> );
            usage();
            <span class="keywordflow">goto</span> CLEANUP;
        }
        
        <span class="comment">/* SMB device address */</span>
        <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"a="</span>)) ) {
            sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;smbAddr );
        }
        <span class="keywordflow">if</span>( ((!smbAddr) &amp;&amp; (strncmp(G_cmd, <span class="stringliteral">"list"</span>, 4))) ) {
            printf( <span class="stringliteral">"***ERROR: missing SMB address!\n"</span> );
            <span class="keywordflow">goto</span> CLEANUP;
        }

        <span class="comment">/* SMB flags */</span>
        <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"F="</span>)) )
            sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;flags );
        <span class="keywordflow">else</span>
            flags = 0x0;

        <span class="comment">/*--------------------+</span>
<span class="comment">        | check SMB2 commands |</span>
<span class="comment">        +--------------------*/</span>
        <span class="comment">/* Dump SMBus */</span>
        <span class="keywordflow">if</span>( !(strncmp(G_cmd, <span class="stringliteral">"list"</span>, 4)) ) {
            SMB2CTRL_List();
        }
        <span class="comment">/* Write Byte */</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !(strncmp(G_cmd, <span class="stringliteral">"wb"</span>, 3)) ) {
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"d="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;byteData );
            }
            <span class="keywordflow">else</span> {
                printf( <span class="stringliteral">"\n***ERROR: missing data!\n"</span> );
                usage();
                ret = 1;
                <span class="keywordflow">goto</span> CLEANUP;
            }
            err = <a name="a5"></a><a class="code" href="group____SMB2__API.html#a4">SMB2API_WriteByte</a>( SMB2CTRL_smbHdl, (u_int8)flags, (u_int8)smbAddr, (u_int8)byteData );
            SMB2CTRL_PrintStatus(err);
            <span class="keywordflow">if</span>( err ){
                ret=1;
                <span class="keywordflow">goto</span> CLEANUP;
            }
        }
        <span class="comment">/* Read Byte */</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !(strncmp(G_cmd, <span class="stringliteral">"rb"</span>, 3)) ) {
            err = <a name="a6"></a><a class="code" href="group____SMB2__API.html#a5">SMB2API_ReadByte</a>( SMB2CTRL_smbHdl, (u_int8)flags, (u_int8)smbAddr, (u_int8*)&amp;byteData );
            <span class="keywordflow">if</span>( err ){
                SMB2CTRL_PrintStatus(err);
                ret=1;
                <span class="keywordflow">goto</span> CLEANUP;
            }
            printf(<span class="stringliteral">"%02x\n"</span>, byteData);
        }
        <span class="comment">/* Write Byte Data */</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !(strncmp(G_cmd, <span class="stringliteral">"wbd"</span>, 3)) ) {
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"o="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;offs );
            }
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"d="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;byteData );
            }
            <span class="keywordflow">else</span> {
                printf( <span class="stringliteral">"\n***ERROR: missing data!\n"</span> );
                usage();
                ret = 1;
                <span class="keywordflow">goto</span> CLEANUP;
            }
            err = <a name="a7"></a><a class="code" href="group____SMB2__API.html#a6">SMB2API_WriteByteData</a>( SMB2CTRL_smbHdl, (u_int8)flags, (u_int8)smbAddr, (u_int8)offs, (u_int8)byteData );
            SMB2CTRL_PrintStatus(err);
            <span class="keywordflow">if</span>( err ){
                ret=1;
                <span class="keywordflow">goto</span> CLEANUP;
            }
        }
        <span class="comment">/* Read Byte Data */</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !(strncmp(G_cmd, <span class="stringliteral">"rbd"</span>, 3)) ) {
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"o="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;offs );
            }
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"n="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;num );
            }
            <span class="keywordflow">else</span>{
                num=1;
            }
            <span class="keywordflow">for</span>( i=0; i&lt;num; i++ ) {
                err = <a name="a8"></a><a class="code" href="group____SMB2__API.html#a7">SMB2API_ReadByteData</a>( SMB2CTRL_smbHdl, (u_int8)flags, (u_int8)smbAddr, ((u_int8)offs+(u_int8)i), (u_int8*)&amp;byteData );
                <span class="keywordflow">if</span>( err ){
                    SMB2CTRL_PrintStatus(err);
                    ret=1;
                    <span class="keywordflow">goto</span> CLEANUP;
                }
                printf( <span class="stringliteral">"%02x "</span>, byteData );
                <span class="keywordflow">if</span>( !((i+1)%16) ) {
                    printf(<span class="stringliteral">"\n"</span>);
                }
            }
            printf( <span class="stringliteral">"\n"</span> );
        }
        <span class="comment">/* Write Word Data */</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !(strncmp(G_cmd, <span class="stringliteral">"wwd"</span>, 3)) ) {
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"o="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;offs );
            }
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"d="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;wordData );
            }
            <span class="keywordflow">else</span> {
                printf( <span class="stringliteral">"\n***ERROR: missing data!\n"</span> );
                usage();
                ret = 1;
                <span class="keywordflow">goto</span> CLEANUP;
            }
            err = <a name="a9"></a><a class="code" href="group____SMB2__API.html#a8">SMB2API_WriteWordData</a>( SMB2CTRL_smbHdl, (u_int8)flags, (u_int8)smbAddr, (u_int8)offs, (u_int16)wordData );
            SMB2CTRL_PrintStatus(err);
            <span class="keywordflow">if</span>( err ){
                ret=1;
                <span class="keywordflow">goto</span> CLEANUP;
            }
        }
        <span class="comment">/* Read Word Data */</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !(strncmp(G_cmd, <span class="stringliteral">"rwd"</span>, 3)) ) {
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"o="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;offs );
            }
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"n="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;num );
            }
            <span class="keywordflow">else</span>{
                num=1;
            }
            <span class="keywordflow">for</span>( i=0; i&lt;num*2; i+=2 ) {
                err = <a name="a10"></a><a class="code" href="group____SMB2__API.html#a9">SMB2API_ReadWordData</a>( SMB2CTRL_smbHdl, (u_int8)flags, (u_int8)smbAddr, ((u_int8)offs+(u_int8)i), (u_int16*)&amp;wordData );
                <span class="keywordflow">if</span>( err ){
                    SMB2CTRL_PrintStatus(err);
                    ret=1;
                    <span class="keywordflow">goto</span> CLEANUP;
                }
                printf( <span class="stringliteral">"%04x "</span>, wordData );
                <span class="keywordflow">if</span>( !((i+2)%16) ) {
                    printf(<span class="stringliteral">"\n"</span>);
                }
            }
            printf( <span class="stringliteral">"\n"</span> );
        }
        <span class="comment">/* Write Block Data */</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !(strncmp(G_cmd, <span class="stringliteral">"wbk"</span>, 3)) ) {
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"o="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;offs );
            }           
            <span class="keywordflow">for</span>( i=3; i&lt;argc; i++ ) {
                <span class="keywordflow">if</span>( *argv[i] != <span class="charliteral">'-'</span> ) {
                    sscanf( argv[i], <span class="stringliteral">"%x"</span>, &amp;tmp );
                    blkData[length] = (u_int8)tmp;
                    printf( <span class="stringliteral">"blkData[%d]=0x%02x\n"</span>, length, blkData[length] );
                    length++;
                    <span class="keywordflow">if</span>( length&gt;(SMB_BLOCK_MAX_BYTES) ) {
                        <span class="keywordflow">break</span>;
                    }
                }
            }
            err = <a name="a11"></a><a class="code" href="group____SMB2__API.html#a10">SMB2API_WriteBlockData</a>( SMB2CTRL_smbHdl, (u_int8)flags, (u_int8)smbAddr, (u_int8)offs, length, blkData );

            <span class="keywordflow">if</span>( err ){
                SMB2CTRL_PrintStatus(err);
                ret=1;
                <span class="keywordflow">goto</span> CLEANUP;
            }
        }
        <span class="comment">/* Read Block Data */</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !(strncmp(G_cmd, <span class="stringliteral">"rbk"</span>, 3)) ) {
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"o="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;offs );
            }
            err = <a name="a12"></a><a class="code" href="group____SMB2__API.html#a11">SMB2API_ReadBlockData</a>( SMB2CTRL_smbHdl, (u_int8)flags, (u_int8)smbAddr, (u_int8)offs, &amp;max_length, blkData );
            <span class="keywordflow">if</span>( err ){
                SMB2CTRL_PrintStatus(err);
                ret=1;
                <span class="keywordflow">goto</span> CLEANUP;
            }
            UTL_Memdump(<span class="stringliteral">"Read data"</span>, (<span class="keywordtype">char</span>*)blkData, max_length, 1);
        }
        <span class="comment">/* QuickComm */</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !(strncmp(G_cmd, <span class="stringliteral">"q"</span>, 1)) ) {
            readwrite = ( UTL_TSTOPT(<span class="stringliteral">"r"</span>) ? <a class="code" href="smb2_8h.html#a9">SMB_READ</a> : <a class="code" href="smb2_8h.html#a10">SMB_WRITE</a> ); <span class="comment">/* read(1) or write(0) access */</span>
            err = <a name="a13"></a><a class="code" href="group____SMB2__API.html#a3">SMB2API_QuickComm</a>( SMB2CTRL_smbHdl, (u_int8)flags, (u_int8)smbAddr, readwrite );
            SMB2CTRL_PrintStatus(err);
            <span class="keywordflow">if</span>( err ){
                ret=1;
                <span class="keywordflow">goto</span> CLEANUP;
            }
        }
        <span class="comment">/* Process Call */</span>
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !(strncmp(G_cmd, <span class="stringliteral">"pc"</span>, 2)) ) {
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"o="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;offs );
            }
            <span class="keywordflow">if</span>( (optP = UTL_TSTOPT(<span class="stringliteral">"d="</span>)) ) {
                sscanf( optP, <span class="stringliteral">"%x"</span>, &amp;wordData );
            }
            <span class="keywordflow">else</span> {
                printf( <span class="stringliteral">"\n***ERROR: missing data!\n"</span> );
                usage();
                ret = 1;
                <span class="keywordflow">goto</span> CLEANUP;
            }
            err = <a name="a14"></a><a class="code" href="group____SMB2__API.html#a12">SMB2API_ProcessCall</a>( SMB2CTRL_smbHdl, (u_int8)flags, (u_int8)smbAddr, (u_int8)offs, (u_int16*)&amp;wordData );
            <span class="keywordflow">if</span>( err ){
                SMB2CTRL_PrintStatus(err);
                ret=1;
                <span class="keywordflow">goto</span> CLEANUP;
            }
            printf(<span class="stringliteral">"%04x\n"</span>, wordData);
        }
        <span class="comment">/* Default */</span>
        <span class="keywordflow">else</span> {
            printf(<span class="stringliteral">"\n***ERROR: SMB2 command not supported!\n"</span>);
            usage();
        }
    }

CLEANUP:
    <span class="comment">/*--------------------+</span>
<span class="comment">    |  exit library       |</span>
<span class="comment">    +--------------------*/</span>
    <span class="keywordflow">if</span>( (err = <a name="a15"></a><a class="code" href="group____SMB2__API.html#a2">SMB2API_Exit</a>( &amp;SMB2CTRL_smbHdl )) ){
        SMB2CTRL_PrintStatus(err);
        ret = 1;
    }
    
EXIT:
    printf(<span class="stringliteral">"\nExiting program...\n"</span>);
    printf(<span class="stringliteral">"Sum of all occured error(s): %u\n"</span>, SMB2CTRL_errCount);

    <span class="keywordflow">return</span> ret;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> int32 SMB2CTRL_CmdHelp( <span class="keywordtype">void</span> )
{
    printf(<span class="stringliteral">"\n"</span>
           <span class="stringliteral">"Commands\n"</span>
           <span class="stringliteral">"========\n"</span>
           <span class="stringliteral">" -h     : HELP (these command list)                      \n"</span>
           <span class="stringliteral">" -e     : EXIT                                           \n"</span>
           <span class="stringliteral">"__________SMB2API___________\n"</span>
           <span class="stringliteral">" -q     : SMB2CTRL_QuickComm                                      \n"</span>
           <span class="stringliteral">" -wb    : SMB2CTRL_WriteByte          -rb    : SMB2CTRL_ReadByte           \n"</span>
           <span class="stringliteral">" -wbd   : SMB2CTRL_WriteByteData      -rbd   : SMB2CTRL_ReadByteData       \n"</span>
           <span class="stringliteral">" -wwd   : SMB2CTRL_WriteWordData      -rwd   : SMB2CTRL_ReadWordData       \n"</span>
           <span class="stringliteral">" -wbk   : SMB2CTRL_WriteBlockData     -rbk   : SMB2CTRL_ReadBlockData      \n"</span>
           <span class="stringliteral">" -pc    : SMB2CTRL_ProcessCall        -bpc   : SMB2CTRL_BlockProcessCall   \n"</span>
           <span class="stringliteral">" -ar    : SMB2CTRL_AlertResponse\n"</span>
           <span class="stringliteral">" -aci   : SMB2CTRL_AlertCbInstall     -acis  : SMB2CTRL_AlertCbInstallSig  \n"</span>
           <span class="stringliteral">" -acr   : SMB2CTRL_AlertCbRemove\n"</span>
           <span class="stringliteral">" -i2c   : SMB2CTRL_I2CXfer\n"</span>
           <span class="stringliteral">" -ers   : SMB2CTRL_Errstring          -id    : SMB2CTRL_Ident              \n"</span>
           <span class="stringliteral">"__________TOOLS___________\n"</span>
           <span class="stringliteral">" -list  : List SMB devices that accepts ReadByte commands.\n"</span>
           <span class="stringliteral">"          A few SMB devices accepts ReadByte commands only\n"</span>
           <span class="stringliteral">"          after other commands or not at all.             \n"</span>
           <span class="stringliteral">" -mt    : Simple memory test (e.g. for EEPROMS)\n"</span>
           <span class="stringliteral">"\n"</span>
           );

    <span class="keywordflow">return</span> -1;
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">static</span> int32 Dispatch( <span class="keywordtype">void</span> )
{
    int32   ii;             
    <span class="keywordtype">char</span>    cmd[CMD_LEN];
    <span class="keywordtype">char</span>    cmdtmp[INPUT_BUF_LEN];
    u_int8  found;

    <span class="keywordflow">while</span>(1) {
        found = FALSE;
        
        printf(<span class="stringliteral">"\ndev=%s ==&gt; cmd: -"</span>, G_dev);

        fflush( stdin );
        
        IGNORE_RET_VAL(scanf(<span class="stringliteral">"%s"</span>,cmdtmp));
        strncpy(cmd, cmdtmp, CMD_LEN);
        cmd[CMD_LEN-1] = 0; <span class="comment">/* klocwork id5163 */</span>

        <span class="comment">/* exit program */</span>
        <span class="keywordflow">if</span> (strcmp(cmd, <span class="stringliteral">"e"</span>) == 0) {
            <span class="keywordflow">return</span> 0;
        }
        
        <span class="comment">/* find the entered command */</span>
        <span class="keywordflow">for</span>(ii = 0; ii &lt; NUMBER_OF_COMMANDS; ii++) {
            
            <span class="comment">/* command found */</span>
            <span class="keywordflow">if</span> (strcmp(cmd, SMB2CTRL_commands[ii].command) == 0) {
                found = TRUE;

                <span class="comment">/* dispatch command */</span>
                SMB2CTRL_PrintStatus( SMB2CTRL_commands[ii].dispFunc() );   
                <span class="keywordflow">break</span>;
            }
        }
        <span class="keywordflow">if</span>( !found )
            printf(<span class="stringliteral">"\007*** Unknown command\n"</span>); 
    }
}

<span class="comment">/**********************************************************************/</span>
<span class="keyword">extern</span> <span class="keywordtype">void</span> SMB2CTRL_PrintStatus( int32 errCode )
{
    <span class="keyword">static</span> <span class="keywordtype">char</span> errMsg[512];

    <span class="keywordflow">switch</span>( errCode ){
    <span class="keywordflow">case</span> -1:
        <span class="keywordflow">return</span>;
    <span class="keywordflow">case</span> 0:
        printf(<span class="stringliteral">" ------------------------- SUCCESS -------------------------\n"</span> );
        <span class="keywordflow">break</span>;
    <span class="keywordflow">default</span>:
        printf(<span class="stringliteral">" ************************** ERROR **************************\n"</span> );
        printf(<span class="stringliteral">"\007 %s\n"</span>, <a name="a16"></a><a class="code" href="group____SMB2__API.html#a16">SMB2API_Errstring</a>( errCode, errMsg ) );
        SMB2CTRL_errCount++;
    }
}


</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for SMB2_API using <a href="http://www.doxygen.org">doxygen</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

