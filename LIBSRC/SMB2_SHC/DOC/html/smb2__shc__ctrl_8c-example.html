<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - SMB2SHC - Example Documentation</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;">
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">SMB2SHC &nbsp; </h1>
	<h3>Example Documentation</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>smb2_shc_ctrl.c</h1><div class="fragment"><pre><span class="comment">/****************************************************************************</span>
<span class="comment"> ************                                                    ************</span>
<span class="comment"> ************                     SMB2_SHC_CTRL                  ************</span>
<span class="comment"> ************                                                    ************</span>
<span class="comment"> ****************************************************************************/</span>
<span class="comment">/*</span>
<span class="comment">* This program is free software: you can redistribute it and/or modify</span>
<span class="comment">* it under the terms of the GNU General Public License as published by</span>
<span class="comment">* the Free Software Foundation, either version 2 of the License, or</span>
<span class="comment">* (at your option) any later version.</span>
<span class="comment">*</span>
<span class="comment">* This program is distributed in the hope that it will be useful,</span>
<span class="comment">* but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment">* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment">* GNU General Public License for more details.</span>
<span class="comment">*</span>
<span class="comment">* You should have received a copy of the GNU General Public License</span>
<span class="comment">* along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="comment">*/</span>

<span class="comment">/* still using deprecated sscanf, sprintf,.. */</span>
<span class="preprocessor">#ifdef WINNT</span>
<span class="preprocessor"></span><span class="preprocessor">#pragma warning(disable:4996)</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">/*-------------------------------------+</span>
<span class="comment">|   INCLUDES                           |</span>
<span class="comment">+-------------------------------------*/</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="smb2__shc_8h.html">MEN/smb2_shc.h</a>&gt;</span>
<span class="preprocessor">#include &lt;MEN/men_typs.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/mdis_api.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/usr_oss.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/usr_utl.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/smb2_api.h&gt;</span>

<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> IdentString[]=MENT_XSTR(MAK_REVISION);

<span class="comment">/*-------------------------------------+</span>
<span class="comment">|   DEFINES                            |</span>
<span class="comment">+-------------------------------------*/</span>
<span class="preprocessor">#define ABS_ZERO    273    </span><span class="comment">/* -273 Celsius = 0 Kelvin */</span>

<span class="comment">/*-------------------------------------+</span>
<span class="comment">|   GLOBALS                            |</span>
<span class="comment">+-------------------------------------*/</span>
u_int32 SMB2CTRL_errCount;
<span class="keywordtype">void</span> *SMB2CTRL_smbHdl;

<span class="comment">/*-------------------------------------+</span>
<span class="comment">|   PROTOTYPES                         |</span>
<span class="comment">+-------------------------------------*/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> header(<span class="keywordtype">void</span>);
<span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keywordtype">void</span>);
<span class="keyword">static</span> <span class="keywordtype">void</span> print_psu(int32 psu_id);
<span class="keyword">static</span> <span class="keywordtype">void</span> print_fan(int32 fan_id);
<span class="keyword">static</span> <span class="keywordtype">void</span> print_voltlevel(<span class="keywordtype">void</span>);
<span class="keyword">static</span> <span class="keywordtype">void</span> print_ups(int32 ups_id);
<span class="keyword">static</span> <span class="keywordtype">void</span> set_persistent_pwrbtn_status(u_int32 status);
<span class="keyword">static</span> <span class="keywordtype">void</span> set_power_cycle_duration(u_int32 duration);
<span class="keyword">static</span> <span class="keywordtype">void</span> print_persistent_pwrbtn_status();
<span class="keyword">static</span> <span class="keywordtype">void</span> shut_down(<span class="keywordtype">void</span>);
<span class="keyword">static</span> <span class="keywordtype">void</span> power_off(<span class="keywordtype">void</span>);
<span class="keyword">static</span> <span class="keywordtype">void</span> print_configdata(<span class="keywordtype">void</span>);
<span class="keyword">static</span> <span class="keywordtype">void</span> get_temperature(<span class="keywordtype">void</span>);
<span class="keyword">static</span> <span class="keywordtype">void</span> set_temperature(int32 tempC);
<span class="keyword">static</span> <span class="keywordtype">void</span> get_psu_state(u_int32 psu_nbr);
<span class="keyword">static</span> <span class="keywordtype">void</span> get_ups_state(u_int32 ups_nbr);
<span class="keyword">static</span> <span class="keywordtype">void</span> get_fan_state(u_int32 fan_nbr);
<span class="keyword">static</span> <span class="keywordtype">void</span> print_firm_version(<span class="keywordtype">void</span>);
<span class="keyword">static</span> <span class="keywordtype">void</span> PrintError(<span class="keywordtype">char</span> *info, int32 errCode);

<span class="comment">/********************************* header ***********************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> header(<span class="keywordtype">void</span>)
{
    printf( <span class="stringliteral">"\n====================="</span>
            <span class="stringliteral">"\n=== SMB2_SHC_CTRL ==="</span>
            <span class="stringliteral">"\n====================="</span>);
    printf(<span class="stringliteral">"\nCopyright (c) 2014-2019, MEN Mikro Elektronik GmbH\n%s\n\n"</span>, IdentString);
}

<span class="comment">/********************************* usage ************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keywordtype">void</span>)
{
    printf(
        <span class="stringliteral">"\nUsage:     smb2_shc_ctrl devName &lt;opts&gt;\n"</span>
        <span class="stringliteral">"Function:  Tool to access the Shelf Controller via the SMB2_SHC API\n"</span>
        <span class="stringliteral">"Options:\n"</span>
        <span class="stringliteral">"    devName       Device name e.g. smb2_1                   \n"</span>
        <span class="stringliteral">"    -?            Usage                                     \n"</span>
        <span class="stringliteral">"    -t            Get system/ambient temperature                    \n"</span>
        <span class="stringliteral">"    -T=[dec]      Set ambient temperature (Celsius) for FAN control \n"</span>
        <span class="stringliteral">"    -i            Get shelf controller API identifier       \n"</span>
        <span class="stringliteral">"    -p=[psu_id]   Get status of one or all PSU              \n"</span>
        <span class="stringliteral">"                  (psu_id: 0 to 3, 0: to get all psu status)\n"</span>
        <span class="stringliteral">"    -f=[fan_id]   Get status of one or all FAN              \n"</span>
        <span class="stringliteral">"                  (fan_id: 0 to 3, 0: to get all fan status)\n"</span>
        <span class="stringliteral">"    -u=[ups_id]   Get status of one or all UPS              \n"</span>
        <span class="stringliteral">"                  (ups_id: 0 to 2, 0: to get all ups status)\n"</span>
        <span class="stringliteral">"    -v            Get input voltage level                   \n"</span>
        <span class="stringliteral">"    -s            Indicates that CPU is shutting down       \n"</span>
        <span class="stringliteral">"    -o            Indicates that CPU wants to shut          \n"</span>
        <span class="stringliteral">"                  off the power supply                      \n"</span>
        <span class="stringliteral">"    -d=[duration] Duration of a power cycle (-o flag) in ms \n"</span>
        <span class="stringliteral">"    -P            Print persistent power button status      \n"</span>
        <span class="stringliteral">"    -B=[status]   Set persistent power button status        \n"</span>
        <span class="stringliteral">"                  status can be 0 (off) or 1 (on)           \n"</span>
        <span class="stringliteral">"    -c            Get Configuration Data                    \n"</span>
        <span class="stringliteral">"    -r            Get Firmware Version                      \n"</span>
        <span class="stringliteral">"Calling examples:                                           \n"</span>
        <span class="stringliteral">"    Get FAN status:  smb2_shc_ctrl smb2_1 -f=0              \n"</span>
        );
}

<span class="comment">/****************************************************************************/</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)
{
    <span class="keywordtype">int</span> err, ret=0, i;
    <span class="keywordtype">char</span> *optP;
    <span class="keywordtype">char</span> *errstr;
    <span class="keywordtype">char</span> argbuf[100];
    <span class="keywordtype">char</span> *deviceP = NULL;
    u_int32 id_nbr=0;
    int32 tempC;

    header();

    <span class="comment">/*--------------------+</span>
<span class="comment">    |  check arguments    |</span>
<span class="comment">    +--------------------*/</span>
    errstr = UTL_ILLIOPT(<span class="stringliteral">"?cf=op=PB=d=irstT=u=v"</span>, argbuf);
    <span class="keywordflow">if</span> (errstr) {
        printf(<span class="stringliteral">"*** %s\n"</span>, errstr);
        usage();
        <span class="keywordflow">return</span> 1;
    }

    <span class="keywordflow">if</span> (UTL_TSTOPT(<span class="stringliteral">"?"</span>)) {
        usage();
        <span class="keywordflow">return</span> 1;
    }

    <span class="comment">/*--------------------+</span>
<span class="comment">    |  get arguments      |</span>
<span class="comment">    +--------------------*/</span>
    <span class="keywordflow">for</span> (i=1; i&lt;argc; i++) {
        <span class="keywordflow">if</span> (*argv[i] != <span class="charliteral">'-'</span>) {
            <span class="keywordflow">if</span> (deviceP == NULL)
                deviceP = argv[i];
        }
    }
    <span class="keywordflow">if</span> (!deviceP) {
        printf(<span class="stringliteral">"***ERROR: missing SMB device name\n"</span>);
        usage();
        <span class="keywordflow">return</span> 1;
    }

    <span class="comment">/*--------------------+</span>
<span class="comment">    |  Init SHC library   |</span>
<span class="comment">    +--------------------*/</span>
    err = <a name="a0"></a><a class="code" href="group____SMB2__SHC.html#a2">SMB2SHC_Init</a>(deviceP);
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2_SHC_Init"</span>, err);
        ret=1;
        <span class="keywordflow">goto</span> EXIT;
    }

    <span class="comment">/* get fan status */</span>
    <span class="keywordflow">if</span> ((optP = UTL_TSTOPT(<span class="stringliteral">"f="</span>))) {
        sscanf(optP, <span class="stringliteral">"%x"</span>, &amp;id_nbr);
        get_fan_state(id_nbr);
    }

    <span class="comment">/* get shelf controller API identifier */</span>
    <span class="keywordflow">if</span> (UTL_TSTOPT(<span class="stringliteral">"i"</span>))
        printf(<span class="stringliteral">"%s\n"</span>, <a name="a1"></a><a class="code" href="group____SMB2__SHC.html#a0">SMB2SHC_Ident</a>());

    <span class="comment">/* get system/ambient temperature */</span>
    <span class="keywordflow">if</span> (UTL_TSTOPT(<span class="stringliteral">"t"</span>))
        get_temperature();

    <span class="comment">/* set ambient temperature */</span>
    <span class="keywordflow">if</span> ((optP = UTL_TSTOPT(<span class="stringliteral">"T="</span>))) {
        sscanf(optP, <span class="stringliteral">"%d"</span>, &amp;tempC);
        set_temperature(tempC);
    }

    <span class="comment">/* get voltage levels */</span>
    <span class="keywordflow">if</span> ((optP = UTL_TSTOPT(<span class="stringliteral">"v"</span>)))
        print_voltlevel();

    <span class="comment">/* get ups status */</span>
    <span class="keywordflow">if</span> ((optP = UTL_TSTOPT(<span class="stringliteral">"u="</span>))) {
        sscanf(optP, <span class="stringliteral">"%x"</span>, &amp;id_nbr);
        get_ups_state(id_nbr);
    }

    <span class="comment">/* indicates that the CPU is shutting down */</span>
    <span class="keywordflow">if</span> ((optP = UTL_TSTOPT(<span class="stringliteral">"s"</span>)))
        shut_down();

    <span class="comment">/* indicates that the CPU wants to shut off the power supply */</span>
    <span class="keywordflow">if</span> ((optP = UTL_TSTOPT(<span class="stringliteral">"o"</span>)))
        power_off();

    <span class="comment">/* Sets the duration of the power cycle (in ms) for a power off request */</span>
    <span class="keywordflow">if</span> ((optP = UTL_TSTOPT(<span class="stringliteral">"d="</span>))) {
        sscanf(optP, <span class="stringliteral">"%d"</span>, &amp;id_nbr);
        set_power_cycle_duration(id_nbr);
    }

    <span class="comment">/* get configuration data */</span>
    <span class="keywordflow">if</span> ((optP = UTL_TSTOPT(<span class="stringliteral">"c"</span>)))
        print_configdata();

    <span class="comment">/* get psu status */</span>
    <span class="keywordflow">if</span> ((optP = UTL_TSTOPT(<span class="stringliteral">"p="</span>))) {
        sscanf(optP, <span class="stringliteral">"%x"</span>, &amp;id_nbr);
        get_psu_state(id_nbr);
    }

    <span class="comment">/* set persistent power button status */</span>
    <span class="keywordflow">if</span> ((optP = UTL_TSTOPT(<span class="stringliteral">"B="</span>))) {
        sscanf(optP, <span class="stringliteral">"%x"</span>, &amp;id_nbr);
        set_persistent_pwrbtn_status(id_nbr);
    }

    <span class="comment">/* get persistent power button status */</span>
    <span class="keywordflow">if</span> ((optP = UTL_TSTOPT(<span class="stringliteral">"P"</span>))) {
        print_persistent_pwrbtn_status();
    }

    <span class="comment">/* get firmware version */</span>
    <span class="keywordflow">if</span> ((optP = UTL_TSTOPT(<span class="stringliteral">"r"</span>)))
        print_firm_version();

EXIT:
    <span class="comment">/*--------------------+</span>
<span class="comment">    |  Exit SHC library   |</span>
<span class="comment">    +--------------------*/</span>
    <a name="a2"></a><a class="code" href="group____SMB2__SHC.html#a3">SMB2SHC_Exit</a>();

    <span class="keywordflow">return</span> ret;
}


<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> print_psu(int32 psu_id)
{
    <span class="keywordtype">int</span> err;
    <span class="keyword">struct </span><a name="_a3"></a><a class="code" href="structshc__psu.html">shc_psu</a> shc_psu_state;

    err = <a name="a4"></a><a class="code" href="group____SMB2__SHC.html#a7">SMB2SHC_GetPSU_State</a>(psu_id, &amp;shc_psu_state);
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_GET_PSU:"</span>, err);
    }
    <span class="keywordflow">else</span> {
        printf(<span class="stringliteral">"-----------------------------------------\n"</span>);
        printf(<span class="stringliteral">"PSU %d Present:\t\t%s\n"</span>, psu_id + 1,
                shc_psu_state.<a name="a5"></a><a class="code" href="structshc__psu.html#m0">isPresent</a> ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>);
        printf(<span class="stringliteral">"PSU %d Failure:\t\t%s\n"</span>, psu_id + 1,
                shc_psu_state.<a name="a6"></a><a class="code" href="structshc__psu.html#m2">intFailure</a> ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>);
        printf(<span class="stringliteral">"PSU %d External PWR:\t%s\n"</span>, psu_id +1,
                shc_psu_state.<a name="a7"></a><a class="code" href="structshc__psu.html#m1">isEPwrPresent</a> ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>);
    }
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> print_fan(int32 fan_id)
{
    <span class="keywordtype">int</span> err;
    <span class="keyword">struct </span><a name="_a8"></a><a class="code" href="structshc__fan.html">shc_fan</a> shc_fan_state;

    err = <a name="a9"></a><a class="code" href="group____SMB2__SHC.html#a8">SMB2SHC_GetFAN_State</a>(fan_id, &amp;shc_fan_state);
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_GET_FAN:"</span>, err);
    }
    <span class="keywordflow">else</span> {
        printf(<span class="stringliteral">"-----------------------------------------\n"</span>);
        printf(<span class="stringliteral">"FAN %d Present:\t\t%s\n"</span>, fan_id + 1,
                shc_fan_state.<a name="a10"></a><a class="code" href="structshc__fan.html#m0">isPresent</a> ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>);
        printf(<span class="stringliteral">"FAN %d Status:\t\t%s\n"</span>, fan_id + 1,
                shc_fan_state.<a name="a11"></a><a class="code" href="structshc__fan.html#m2">state</a> == SHC_FAN_OK ? <span class="stringliteral">"OK"</span> : <span class="stringliteral">"FAIL"</span>);
        printf(<span class="stringliteral">"FAN %d Speed (rpm):\t%d\n"</span>, fan_id + 1,
                shc_fan_state.<a name="a12"></a><a class="code" href="structshc__fan.html#m1">speedRpm</a>);
    }
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> print_voltlevel()
{
    <span class="keywordtype">int</span> i, err, pwr_mon_nr;
    u_int16 voltlevel;

    printf(<span class="stringliteral">"Voltage Level Reporting:\n"</span>);
    printf(<span class="stringliteral">"-----------------------------------------\n"</span>);

    <span class="keywordflow">for</span> (i=SHC_PWR_MON_1; i&lt;=SHC_PWR_MON_4; i++) {
        err = <a name="a13"></a><a class="code" href="group____SMB2__SHC.html#a9">SMB2SHC_GetVoltLevel</a>(i, &amp;voltlevel);
        <span class="keywordflow">if</span> (err) {
            PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_GET_VOLT_LEVEL:"</span>, err);
            <span class="keywordflow">continue</span>;
        }
        pwr_mon_nr = i + 1;
        printf(<span class="stringliteral">"PWR_MON %d Voltage Level in mV:\t\t%d\n"</span>, pwr_mon_nr, voltlevel);
    }
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> print_ups(int32 ups_id)
{
    <span class="keywordtype">int</span> err;
    <span class="keyword">struct </span><a name="_a14"></a><a class="code" href="structshc__ups.html">shc_ups</a> shc_ups_state;

    err = <a name="a15"></a><a class="code" href="group____SMB2__SHC.html#a13">SMB2SHC_GetUPS_State</a>(ups_id, &amp;shc_ups_state);
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_GET_UPS:"</span>, err);
    }
    <span class="keywordflow">else</span> {
        printf(<span class="stringliteral">"-----------------------------------------\n"</span>);
        printf(<span class="stringliteral">"UPS %d Present:\t\t%s\n"</span>, ups_id + 1,
            shc_ups_state.<a name="a16"></a><a class="code" href="structshc__ups.html#m0">isPresent</a> ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>);
        printf(<span class="stringliteral">"UPS %d Failure:\t\t%s\n"</span>, ups_id + 1,
            shc_ups_state.<a name="a17"></a><a class="code" href="structshc__ups.html#m2">intFailure</a> ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>);
        printf(<span class="stringliteral">"UPS %d provides PWR:\t%s\n"</span>, ups_id + 1,
            shc_ups_state.<a name="a18"></a><a class="code" href="structshc__ups.html#m1">provPWR</a> ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>);
        printf(<span class="stringliteral">"UPS %d charging level in %%: %d\n"</span>, ups_id + 1, shc_ups_state.<a name="a19"></a><a class="code" href="structshc__ups.html#m3">chrg_lvl</a>);
    }
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> get_temperature()
{
    <span class="keywordtype">int</span> err;
    u_int16 tempK = 0;
    int16 tempC = 0;

    err = <a name="a20"></a><a class="code" href="group____SMB2__SHC.html#a4">SMB2SHC_GetTemperature</a>((u_int16*)&amp;tempK);
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_GET_TEMP"</span>, err);
    }
    <span class="keywordflow">else</span>{
        u_int16 status = 0;
        <span class="keywordtype">int</span> err = <a name="a21"></a><a class="code" href="group____SMB2__SHC.html#a5">SMB2SHC_GetTemperatureOverrideStatus</a>(&amp;status);
        <span class="keywordflow">if</span> (err) {
            PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_GET_TEMPERATURE_OVERRIDE"</span>, err);
        }
        <span class="keywordflow">if</span> (status) {
            printf(<span class="stringliteral">"Temperature is overridden by host.\n"</span>);
        }
        <span class="comment">/* get Celsius */</span>
        tempC = tempK - ABS_ZERO;
        printf(<span class="stringliteral">"Temperature: %dK (%dC)\n"</span>, tempK, tempC);
    }
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> set_temperature(int32 tempC)
{
    <span class="keywordtype">int</span> err;
    u_int16 tempK;

    printf(<span class="stringliteral">"Set ambient temperature to %dC (for at least 40sec).\n"</span>, tempC);

    <span class="comment">/* get Kelvin */</span>
    tempK = (u_int16)(tempC + ABS_ZERO);

    err = <a name="a22"></a><a class="code" href="group____SMB2__SHC.html#a6">SMB2SHC_SetTemperature</a>(tempK);
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_SET_TEMP"</span>, err);
    }
    <span class="keywordflow">else</span>{
        <span class="comment">/* read back temperature */</span>
        err = <a class="code" href="group____SMB2__SHC.html#a4">SMB2SHC_GetTemperature</a>((u_int16*)&amp;tempK);
        <span class="keywordflow">if</span> (err) {
            PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_GET_TEMP"</span>, err);
        }
        <span class="keywordflow">else</span>{
            tempC = (int32)(tempK - ABS_ZERO);
            printf(<span class="stringliteral">"New Temperature: %dK (%dC)\n"</span>, tempK, tempC);
        }
    }
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> print_persistent_pwrbtn_status()
{
    u_int8 status;
    <span class="keywordtype">int</span> err = <a name="a23"></a><a class="code" href="group____SMB2__SHC.html#a12">SMB2SHC_GetPersistentPowerbuttonStatus</a>((u_int8*)&amp;status);
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_GetPersistentPowerbuttonStatus"</span>, err);
    }
    <span class="keywordflow">else</span>{
        printf(<span class="stringliteral">"Persistent Power Button Status: %s\n"</span>, status == 1 ? <span class="stringliteral">"ON"</span> : <span class="stringliteral">"OFF"</span>);
    }
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> set_persistent_pwrbtn_status(u_int32 status)
{
    <span class="keywordtype">int</span> err = <a name="a24"></a><a class="code" href="group____SMB2__SHC.html#a11">SMB2SHC_SetPersistentPowerbuttonStatus</a>(status);
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_SetPersistentPowerbuttonStatus"</span>, err);
    } <span class="keywordflow">else</span> {
        printf(<span class="stringliteral">"Setting persistent power button to: %s\n"</span>, status == 1 ? <span class="stringliteral">"ON"</span> : <span class="stringliteral">"OFF"</span>);
    }
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> set_power_cycle_duration(u_int32 duration)
{
    <span class="keywordtype">int</span> err = <a name="a25"></a><a class="code" href="group____SMB2__SHC.html#a10">SMB2SHC_SetPowerCycleDuration</a>((u_int16)duration);
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_SetPowerCycleDuration:"</span>, err);
    } <span class="keywordflow">else</span> {
        printf(<span class="stringliteral">"Setting power cycle duration to %d milliseconds.\n"</span>, duration);
        printf(<span class="stringliteral">"The shelf controller may clamp this value to a min/max interval."</span>);
    }
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> shut_down()
{
    <span class="keywordtype">int</span> err;

    printf(<span class="stringliteral">"CPU is shutting down now.\n"</span>);

    err = <a name="a26"></a><a class="code" href="group____SMB2__SHC.html#a14">SMB2SHC_ShutDown</a>();
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_SHUT_DOWN:"</span>, err);
    }
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> power_off()
{
    <span class="keywordtype">int</span> err;

    printf(<span class="stringliteral">"Shutting off power supply now.\n"</span>);

    err = <a name="a27"></a><a class="code" href="group____SMB2__SHC.html#a15">SMB2SHC_PowerOff</a>();
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_POWER_OFF:"</span>, err);
    }
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> print_slot_status(u_int8 slot_status, int32 slot_nbr)
{
    <span class="keywordflow">if</span> (slot_status == SHC_SLOT_EMPTY)
        printf(<span class="stringliteral">"Slot %d is empty.\n"</span>, slot_nbr);
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (slot_status == SHC_SLOT_PSU)
        printf(<span class="stringliteral">"Slot %d contains PSU.\n"</span>, slot_nbr);
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (slot_status == SHC_SLOT_UPS)
        printf(<span class="stringliteral">"Slot %d contains UPS.\n"</span>, slot_nbr);
    <span class="keywordflow">else</span>
        printf(<span class="stringliteral">"Slot status not defined.\n"</span>);
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> print_configdata()
{
    <span class="keywordtype">int</span> err;
    <span class="keyword">struct </span><a name="_a28"></a><a class="code" href="structshc__configdata.html">shc_configdata</a> cdata;

    printf(<span class="stringliteral">"Configuration Data Reporting:\n"</span>);
    printf(<span class="stringliteral">"-----------------------------------------\n"</span>);

    err = <a name="a29"></a><a class="code" href="group____SMB2__SHC.html#a16">SMB2SHC_GetConf_Data</a>(&amp;cdata);
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_GetConf_Data:"</span>, err);
    }
    <span class="keywordflow">else</span> {
        print_slot_status(cdata.<a name="a30"></a><a class="code" href="structshc__configdata.html#m0">pwrSlot2</a>, 2);
        print_slot_status(cdata.<a name="a31"></a><a class="code" href="structshc__configdata.html#m1">pwrSlot3</a>, 3);
        printf(<span class="stringliteral">"-----------------------------------------\n"</span>);
        printf(<span class="stringliteral">"UPS Minimum Start Charge in %%: \t\t%d\n"</span>, cdata.<a name="a32"></a><a class="code" href="structshc__configdata.html#m2">upsMinStartCharge</a>);
        printf(<span class="stringliteral">"UPS Minimum Run Charge in %%: \t\t%d\n"</span>, cdata.<a name="a33"></a><a class="code" href="structshc__configdata.html#m3">upsMinRunCharge</a>);
        printf(<span class="stringliteral">"-----------------------------------------\n"</span>);
        printf(<span class="stringliteral">"Low Temperature Warning Limit in K: \t%d\n"</span>, cdata.<a name="a34"></a><a class="code" href="structshc__configdata.html#m6">tempWarnLow</a>);
        printf(<span class="stringliteral">"Upper Temperature Warning Limit in K: \t%d\n"</span>, cdata.<a name="a35"></a><a class="code" href="structshc__configdata.html#m7">tempWarnHigh</a>);
        printf(<span class="stringliteral">"Low Temperature Run Limit in K: \t%d\n"</span>, cdata.<a name="a36"></a><a class="code" href="structshc__configdata.html#m8">tempRunLow</a>);
        printf(<span class="stringliteral">"High Temperature Run Limit in K: \t%d\n"</span>, cdata.<a name="a37"></a><a class="code" href="structshc__configdata.html#m9">tempRunHigh</a>);
        printf(<span class="stringliteral">"-----------------------------------------\n"</span>);
        printf(<span class="stringliteral">"Persistent power button enabled: \t%s\n"</span>, cdata.<a name="a38"></a><a class="code" href="structshc__configdata.html#m4">persistentPwrbtnEnabled</a> ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>);
        printf(<span class="stringliteral">"PBRST during DEL_START enabled: \t%s\n"</span>, cdata.<a name="a39"></a><a class="code" href="structshc__configdata.html#m5">usePBRST</a> ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>);
        printf(<span class="stringliteral">"-----------------------------------------\n"</span>);
        printf(<span class="stringliteral">"Number of Fans: %d\n"</span>, cdata.<a name="a40"></a><a class="code" href="structshc__configdata.html#m10">fanNum</a>);
        printf(<span class="stringliteral">"Fan Min Duty Cycle in %%: \t\t%d\n"</span>, cdata.<a name="a41"></a><a class="code" href="structshc__configdata.html#m11">fanDuCyMin</a>);
        printf(<span class="stringliteral">"Fan Start Temperature in K: \t\t%d\n"</span>, cdata.<a name="a42"></a><a class="code" href="structshc__configdata.html#m12">fanTempStart</a>);
        printf(<span class="stringliteral">"Fan Max Speed Temperature in K: \t%d\n"</span>, cdata.<a name="a43"></a><a class="code" href="structshc__configdata.html#m13">fanTempMax</a>);
        printf(<span class="stringliteral">"-----------------------------------------\n"</span>);
        printf(<span class="stringliteral">"Voltage channel mask in decimal: \t%d\n"</span>, cdata.<a name="a44"></a><a class="code" href="structshc__configdata.html#m14">voltMonMask</a>);
        printf(<span class="stringliteral">"-----------------------------------------\n"</span>);
        printf(<span class="stringliteral">"SMBus address: \t0x%x\n"</span>, cdata.<a name="a45"></a><a class="code" href="structshc__configdata.html#m15">i2cAddress</a> == 0xff ? 0x75 : cdata.<a class="code" href="structshc__configdata.html#m15">i2cAddress</a>);
        printf(<span class="stringliteral">"-----------------------------------------\n"</span>);
        printf(<span class="stringliteral">"SHC State Machine ID: \t%d\n"</span>, cdata.<a name="a46"></a><a class="code" href="structshc__configdata.html#m16">StateMachineID</a>);
    }
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> get_psu_state(u_int32 psu_nbr)
{
    <span class="keywordtype">int</span> i;

    printf(<span class="stringliteral">"Power Supply Reporting:\n"</span>);

    <span class="keywordflow">if</span> (psu_nbr == 0) {
        <span class="keywordflow">for</span> (i = SHC_PSU1; i &lt;= SHC_PSU3; i++) {
            print_psu(i);
        }
    }
    <span class="keywordflow">else</span>
        print_psu(psu_nbr - 1);
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> get_ups_state(u_int32 ups_nbr)
{
    <span class="keywordtype">int</span> i;

    printf(<span class="stringliteral">"Uninterruptible Power Supply Reporting:\n"</span>);

    <span class="keywordflow">if</span> (ups_nbr == 0) {
        <span class="keywordflow">for</span> (i=SHC_UPS1; i&lt;=SHC_UPS2; i++) {
            print_ups(i);
        }
    }
    <span class="keywordflow">else</span>
        print_ups(ups_nbr - 1);
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> get_fan_state(u_int32 fan_nbr)
{
    <span class="keywordtype">int</span> i;

    printf(<span class="stringliteral">"Fan Status Reporting:\n"</span>);

    <span class="keywordflow">if</span> (fan_nbr == 0) {
        <span class="keywordflow">for</span> (i=SHC_FAN1; i&lt;=SHC_FAN3; i++) {
            print_fan(i);
        }
    }
    <span class="keywordflow">else</span>
        print_fan(fan_nbr - 1);
}

<span class="comment">/****************************************************************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> print_firm_version()
{
    <span class="keywordtype">int</span> err;
    <span class="keyword">struct </span><a name="_a47"></a><a class="code" href="structshc__fwversion.html">shc_fwversion</a> firm_version;

    printf(<span class="stringliteral">"Firmware Version:\n"</span>);
    printf(<span class="stringliteral">"-----------------------------------------\n"</span>);

    err = <a name="a48"></a><a class="code" href="group____SMB2__SHC.html#a17">SMB2SHC_GetFirm_Ver</a>(&amp;firm_version);
    <span class="keywordflow">if</span> (err) {
        PrintError(<span class="stringliteral">"***ERROR: SMB2SHC_GetFirm_Ver:"</span>, err);
    }
    <span class="keywordflow">else</span> {
        printf(<span class="stringliteral">"Error Code: %s\n"</span>, firm_version.<a name="a49"></a><a class="code" href="structshc__fwversion.html#m0">errcode</a> ? <span class="stringliteral">"ERROR"</span> : <span class="stringliteral">"OK"</span>);
        printf(<span class="stringliteral">"BMC Firmware Revision %d.%.02d\n"</span>, firm_version.<a name="a50"></a><a class="code" href="structshc__fwversion.html#m1">maj_revision</a>,
                                                    firm_version.<a name="a51"></a><a class="code" href="structshc__fwversion.html#m2">min_revision</a>);
        printf(<span class="stringliteral">"BMC Maintenance Revision: %d\n"</span>, firm_version.<a name="a52"></a><a class="code" href="structshc__fwversion.html#m3">mtnce_revision</a>);
        printf(<span class="stringliteral">"BMC Firmware Build Number: %d\n"</span>, firm_version.<a name="a53"></a><a class="code" href="structshc__fwversion.html#m4">build_nbr</a>);
        printf(<span class="stringliteral">"Verified: %s\n"</span>, firm_version.<a name="a54"></a><a class="code" href="structshc__fwversion.html#m5">veri_flag</a> ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>);
    }
}

<span class="comment">/******************************** PrintError ********************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> PrintError(<span class="keywordtype">char</span> *info, int32 errCode)
{
    <span class="keyword">static</span> <span class="keywordtype">char</span> errMsg[512];

    <span class="keywordflow">if</span> (!errCode)
        errCode = UOS_ErrnoGet();

    printf(<span class="stringliteral">"%s: %s\n"</span>, info, <a name="a55"></a><a class="code" href="group____SMB2__SHC.html#a1">SMB2SHC_Errstring</a>(errCode, errMsg));
}

</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for SMB2SHC using <a href="http://www.doxygen.org">doxygen</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

